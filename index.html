<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturación con TBAI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 98vw;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .form-section, .preview-section {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 24px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .form-section label, .form-section input, .form-section select, .form-section textarea {
            font-size: 13px !important;
        }

        .form-section h3 {
            margin: 10px 0 5px 0 !important;
            font-size: 16px !important;
            color: #34495e;
        }

        .form-group {
            margin-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            cursor: pointer;
            transition: all 0.25s ease;
            background: none;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.5px;
            line-height: 1;
            color: var(--color);
            border-color: var(--color);
        }
        
        /* Variaciones de tamaño */
        #grid-section .btn {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-small {
            padding: 2px 8px !important;
            font-size: 12px !important;
            min-width: auto !important;
            border-width: 1px !important;
            line-height: 1.2 !important;
        }
        
        /* Estados base */
        .btn:hover,
        .btn:focus {
            color: #fff;
            outline: none;
            box-shadow: inset 0 0 0 2em var(--hover);
            border-color: var(--hover);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        /* Variantes de color */
        .btn-primary {
            --color: #3498db;
            --hover: #2980b9;
        }
        
        .btn-success {
            --color: #27ae60;
            --hover: #229954;
        }
        
        .btn-secondary {
            --color: #95a5a6;
            --hover: #7f8c8d;
        }
        
        /* Botón warning - estilo especial */
        .btn-warning {
            --color: #f39c12;
            --hover: #e67e22;
            background: var(--color);
            color: white;
        }
        
        .btn-warning:hover,
        .btn-warning:focus {
            background: var(--hover) !important;
            border-color: var(--hover) !important;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        

        .items-section {
            margin-top: 10px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .item-header {
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }

        /* Botones especializados que extienden .btn */
        .btn-remove {
            --color: #e74c3c;
            --hover: #c0392b;
            padding: 8px 12px;
        }

        .btn-add {
            --color: #27ae60;
            --hover: #229954;
            margin-top: 10px;
        }

        /* Preview Section Styles */
        .invoice-preview {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Sistema de Notificaciones */
        .notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px 20px;
            border-left: 4px solid;
            transform: translateX(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left-color: #27ae60;
            background: linear-gradient(90deg, rgba(39, 174, 96, 0.1) 0%, white 100%);
        }

        .notification.error {
            border-left-color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.1) 0%, white 100%);
        }

        .notification.warning {
            border-left-color: #f39c12;
            background: linear-gradient(90deg, rgba(243, 156, 18, 0.1) 0%, white 100%);
        }

        .notification.info {
            border-left-color: #3498db;
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 0%, white 100%);
        }

        .notification-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .notification-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            color: #333;
        }

        .notification-body {
            color: #666;
            white-space: pre-line;
        }

        .actions-section {
            text-align: center;
            margin-top: 30px;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Ocultar elementos de la interfaz, pero mantener la factura intacta */
            .header-fixed,
            .notifications-container,
            .form-section,
            .actions-section,
            .btn,
            button,
            input,
            select,
            textarea,
            .dropdown,
            .nav-menu,
            .item-header,
            .items-section,
            #items-container,
            #grid-section,
            .table-container,
            h1:not(#invoice-preview h1),
            h2:not(#invoice-preview h2),
            .main-layout .form-section,
            .preview-section > h2,
            .loading,
            .stats-container,
            .filter-menu,
            .emisores-modal,
            .modal {
                display: none !important;
            }

            /* Resetear contenedores */
            .container {
                max-width: none !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
            }

            .main-layout {
                display: block !important;
            }

            .preview-section {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                background: white !important;
                border-radius: 0 !important;
                width: 100% !important;
            }

            /* Mantener la factura exactamente como está en pantalla */
            #invoice-preview {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                box-shadow: none !important;
                border: none !important;
            }

            /* Asegurar que los colores y bordes se impriman */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Ocultar iconos web en PDF y mostrar URLs como texto plano */
            .web-only {
                display: none !important;
            }
            
            /* Asegurar que las URLs sean claramente visibles en PDF */
            #invoice-preview .tbai-url,
            #invoice-preview .verification-url {
                font-family: monospace !important;
                font-size: 5pt !important;
                color: #000 !important;
                word-break: break-all !important;
                text-decoration: none !important;
            }
        }



        /* Estilos para enlaces en pantalla */
        .tbai-url, .verification-url {
            text-decoration: underline;
            transition: color 0.2s;
        }

        .tbai-url:hover, .verification-url:hover {
            color: #3498db !important;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .error {
            border-color: #e74c3c !important;
        }

        .hidden {
            display: none;
        }

        /* Ajuste de alineación para totales */
        .totales-factura-ajustada {
            text-align: left !important;
            margin-left: 10px !important;
        }

        /* Ajuste específico para totales */
        .totales-ajustados {
            margin-left: 0.5cm !important;
        }

        /* Estilos mejorados para el grid de facturas */
        #invoicesGrid {
            font-size: 12px;
            table-layout: fixed;
            width: 100%;
            min-width: 1800px; /* Ancho mínimo para forzar scroll horizontal */
        }
        
        /* Contenedor con scroll horizontal */
        .table-container {
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        
        /* Barra de scroll personalizada */
        .table-container::-webkit-scrollbar {
            height: 14px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 0 0 8px 8px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #invoicesGrid thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #invoicesGrid th {
            padding: 4px 50px 4px 6px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            user-select: none;
            min-width: 50px; /* Ancho mínimo para las columnas */
            font-size: 12px;
            height: 36px; /* Más estrecha */
            overflow: visible; /* Cambiado para mostrar las flechas */
            text-overflow: ellipsis;
        }
        
        /* Manejador de redimensionado de columnas */
        .column-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            z-index: 20;
            transition: background-color 0.2s;
        }
        
        .column-resizer:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .resizing {
            cursor: col-resize !important;
            user-select: none !important;
        }
        
        .resizing * {
            cursor: col-resize !important;
            user-select: none !important;
        }

        /* Estilo para el indicador visual durante el redimensionado */
        .resizing .column-resizer {
            background: rgba(255, 255, 255, 0.5);
            width: 2px;
            right: 3px;
        }

        #invoicesGrid th:last-child {
            border-right: none;
        }

        #invoicesGrid th.sortable {
            cursor: default !important; /* Cursor por defecto, solo el texto tendrá pointer */
        }

        #invoicesGrid th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Asegurar que solo el texto de la cabecera tenga cursor pointer */
        #invoicesGrid th .header-text {
            cursor: pointer !important;
        }

        #invoicesGrid th .filter-icon {
            cursor: pointer !important;
        }

        #invoicesGrid td {
            padding: 2px 6px;
            border-bottom: 1px solid #ecf0f1;
            border-right: 1px solid #f0f0f0;
            height: 24px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 12px;
            min-width: 0; /* Sin ancho mínimo */
        }

        #invoicesGrid td:last-child {
            border-right: none;
        }

        #invoicesGrid tbody tr {
            transition: all 0.2s ease;
            cursor: default;
            height: 24px;
        }

        #invoicesGrid tbody tr:hover {
            background-color: #d6ebff !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.25);
        }

        #invoicesGrid tbody tr.selected {
            background-color: #e3f2fd;
        }

        /* Indicadores de ordenación SUPER VISTOSOS */

        /* Estado sin ordenar - Flecha gris */
        .sort-indicator.sort-none {
            color: rgba(255, 255, 255, 0.4);
            font-size: 16px;
        }

        /* Flecha ascendente - Azul eléctrico brillante */
        .sort-indicator.sort-asc {
            color: #00d4ff;
            text-shadow: 
                0 0 5px #00d4ff,
                0 0 10px #00d4ff,
                0 0 15px #00d4ff,
                0 0 20px #0080ff;
            animation: neon-pulse-up 1.5s ease-in-out infinite;
            filter: brightness(1.5) contrast(1.2);
        }

        /* Flecha descendente - Azul eléctrico brillante */
        .sort-indicator.sort-desc {
            color: #00d4ff;
            text-shadow: 
                0 0 5px #00d4ff,
                0 0 10px #00d4ff,
                0 0 15px #00d4ff,
                0 0 20px #0080ff;
            animation: neon-pulse-down 1.5s ease-in-out infinite;
            filter: brightness(1.5) contrast(1.2);
        }



        /* Animaciones espectaculares */
        @keyframes neon-pulse-up {
            0%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-3px) scale(1.1);
                opacity: 1;
            }
        }

        @keyframes neon-pulse-down {
            0%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(3px) scale(1.1);
                opacity: 1;
            }
        }


        @keyframes glow-pulse {
            0%, 100% { 
                box-shadow: 
                    0 0 5px rgba(255, 255, 255, 0.1),
                    0 0 10px rgba(255, 255, 255, 0.1),
                    0 0 15px rgba(255, 255, 255, 0.1);
            }
            50% { 
                box-shadow: 
                    0 0 10px rgba(255, 255, 255, 0.2),
                    0 0 20px rgba(255, 255, 255, 0.2),
                    0 0 30px rgba(255, 255, 255, 0.2);
            }
        }

        /* Efecto hover en los headers */
        .header-text:hover .sort-indicator::before {
            animation-duration: 0.5s;
            transform: scale(1.2);
        }

        /* Número de prioridad para ordenamiento múltiple */
        .sort-priority {
            display: block;
            font-size: 10px;
            font-weight: normal;
            color: #fff;
            background: #27ae60;
            padding: 1px 4px;
            border-radius: 3px;
            line-height: 1;
            margin-top: 2px;
            text-align: center;
        }

        /* Contenedor del título de la columna */
        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
        }
        
        .header-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Ajustar el contenedor del indicador */
        .sort-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 20px;
            vertical-align: middle;
            font-weight: bold;
        }

        .filter-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            line-height: 1;
        }

        .filter-icon:hover {
            color: white;
            background: rgba(0, 0, 0, 0.4);
            transform: translateY(-50%) scale(1.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .filter-icon.active {
            color: #fff;
            background: #e74c3c;
            font-weight: bold;
            box-shadow: 0 0 12px rgba(231, 76, 60, 0.8);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.8);
            }
            50% {
                box-shadow: 0 0 20px rgba(231, 76, 60, 1);
            }
            100% {
                box-shadow: 0 0 12px rgba(231, 76, 60, 0.8);
            }
        }

        /* Checkbox mejorado */
        .checkbox-cell {
            width: 30px;
            text-align: center;
            padding: 2px !important;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            margin: 0;
        }

        /* Números alineados a la derecha */
        .number-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        
        /* Ajustes para mostrar más filas y scroll */
        #grid-section .container {
            height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #grid-section .table-container {
            flex: 1;
            min-height: 0;
            margin-top: 10px;
        }

        /* Menú de filtros */
        .filter-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 280px;
            display: none;
        }

        .filter-menu-header {
            background: #34495e;
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-menu-close {
            cursor: pointer;
            font-size: 24px;
            color: #ff0040;
            text-shadow: 0 0 10px #ff0040, 0 0 20px #ff0040, 0 0 30px #ff0040;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .filter-menu-close:hover {
            color: #ff3366;
            text-shadow: 0 0 15px #ff3366, 0 0 30px #ff3366, 0 0 45px #ff3366;
            transform: scale(1.2);
        }
        
        /* Botón morado */
        .btn-purple {
            --color: #9b59b6;
            --hover: #8e44ad;
            background: var(--color);
            border-color: var(--color);
            color: white;
        }
        
        .btn-purple:hover,
        .btn-purple:focus {
            background: var(--hover) !important;
            border-color: var(--hover) !important;
            color: white !important;
        }

        .filter-menu-content {
            padding: 16px;
            text-align: left;
        }

        .filter-group {
            margin-bottom: 12px;
            text-align: left;
        }

        .filter-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            text-align: left;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-menu-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: white;
        }
        
        .filter-btn-apply { background: #27ae60; }
        .filter-btn-apply:hover { background: #229954; }
        .filter-btn-clear { background: #f39c12; }
        .filter-btn-clear:hover { background: #e67e22; }
        .filter-btn-cancel { background: #95a5a6; }
        .filter-btn-cancel:hover { background: #7f8c8d; }
        
        /* Forzar alineación a la izquierda en el menú de filtros */
        .filter-menu * {
            text-align: left !important;
        }

        /* Modal de Gestión de Emisores */
        .emisores-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .emisores-modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
        }

        .emisores-modal-header {
            background: #34495e;
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emisores-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .emisores-modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #ff0040;
            text-shadow: 0 0 10px #ff0040;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .emisores-modal-close:hover {
            color: #ff3366;
            text-shadow: 0 0 15px #ff3366;
            transform: scale(1.2);
        }

        .emisores-modal-body {
            padding: 20px;
        }

        .emisores-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .emisores-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .emisores-tab.active {
            color: #34495e;
            border-bottom-color: #34495e;
        }

        .emisores-tab:hover {
            color: #34495e;
        }

        .emisores-tab-content {
            display: none;
        }

        .emisores-tab-content.active {
            display: block;
        }

        .emisores-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .emisor-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .emisor-item:hover {
            background: #f8f9fa;
        }

        .emisor-item:last-child {
            border-bottom: none;
        }

        .emisor-info {
            flex: 1;
        }

        .emisor-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .emisor-details {
            font-size: 12px;
            color: #6c757d;
        }

        .emisor-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-edit { background: #3498db; }
        .btn-edit:hover { background: #2980b9; }
        .btn-select { background: #27ae60; }
        .btn-select:hover { background: #229954; }
        .btn-delete { background: #e74c3c; }
        .btn-delete:hover { background: #c0392b; }
        
        .filter-menu .filter-menu-header {
            text-align: center !important; /* Solo el header centrado */
        }
        
        .filter-menu .filter-menu-actions {
            text-align: center !important; /* Solo los botones centrados */
        }
        
        /* Permitir flexbox para checkboxes alineados a la derecha */
        .filter-menu label[style*="justify-content: space-between"] {
            text-align: initial !important;
        }
        
        /* Alineación vertical de checkboxes en el menú de filtros */
        .filter-menu #groupingOptions label {
            min-height: 24px;
            padding-right: 20px;
        }
        
        .filter-menu #groupingOptions input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .filter-menu #enableGrouping {
            width: 16px;
            height: 16px;
        }

        /* Estilos para las opciones del menú de filtros */
        .hide-column-link, .autofit-column-link, .autofit-all-link {
            color: #3498db !important;
            font-size: 14px;
            padding: 5px 0;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .hide-column-link:hover, .autofit-column-link:hover, .autofit-all-link:hover {
            color: #2980b9 !important;
            background-color: #f8f9fa;
            padding-left: 8px;
            transform: translateX(3px);
        }

        /* Estadísticas */
        .stats-bar {
            background: #f8f9fa;
            padding: 15px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            flex-shrink: 0;
            margin-top: 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
            min-width: 150px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .editable {
            cursor: text;
            position: relative;
        }

        .editable:hover {
            background-color: #fffbf0;
            outline: 1px dashed #f39c12;
        }

        .editing {
            padding: 4px;
            border: 2px solid #3498db;
            border-radius: 2px;
            background: white;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        /* Header fijo */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #2c3e50;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
            height: 50px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h1 {
            font-size: 24px;
            margin: 0;
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-menu .btn-header {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu .btn-header:hover {
            background: #27ae60;
            border-color: #27ae60;
            transform: translateY(-2px);
            color: white;
        }

        .nav-menu .btn-header.primary {
            background: #3498db;
            border-color: #3498db;
        }

        .nav-menu .btn-header.primary:hover {
            background: #2980b9;
            border-color: #2980b9;
            transform: translateY(-2px);
        }

        /* Ajustar el contenido principal para el header fijo */
        body {
            padding-top: 60px;
        }

        .container {
            margin-top: 5px;
        }

        /* Dropdown menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #34495e;
            min-width: 280px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Enlaces deshabilitados en dropdown */
        .dropdown-content a.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .dropdown-content a.disabled:hover {
            background-color: transparent !important;
            padding-left: 20px !important;
        }
        
        /* Estilo para el botón de imprimir cuando está listo */
        .dropdown-content a.print-ready {
            font-weight: 600;
            position: relative;
        }
        
        .dropdown-content a.print-ready::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background-color: #27ae60;
            border-radius: 2px;
        }

        .dropdown-content a {
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            display: block;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .dropdown-content a:hover {
            background-color: #27ae60;
            padding-left: 25px;
            color: white;
        }
        
        /* Efecto de onda verde */
        .dropdown-content a::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #27ae60;
            transition: width 0.3s ease;
        }
        
        .dropdown-content a:hover::after {
            width: 100%;
            z-index: -1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Efecto verde al hacer hover en el botón de herramientas */
        .dropdown:hover .btn-header {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        /* Header scroll effect */
        .header-fixed.scrolled {
            height: 45px;
            background: #34495e;
        }

        .header-fixed.scrolled .header-content {
            height: 45px;
        }

        .header-fixed.scrolled .logo-section h1 {
            font-size: 18px;
        }

        /* Botón de eliminación - variante roja */
        .btn-delete {
            --color: #e74c3c;
            --hover: #c0392b;
        }

        /* ========== EDITOR DE TEXTO ENRIQUECIDO ========== */
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 4px 6px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }

        .editor-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
            min-width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
        }

        .editor-btn:hover {
            background: #e9ecef;
            color: #212529;
        }

        .editor-btn:active {
            background: #dee2e6;
            transform: scale(0.95);
        }

        .editor-btn.active {
            background: #3498db;
            color: white;
        }

        .editor-btn.active:hover {
            background: #2980b9;
        }

        .editor-separator {
            color: #dee2e6;
            margin: 0 6px;
            font-size: 16px;
        }

        .rich-text-editor {
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 0 0 4px 4px;
            background: white;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
        }

        .rich-text-editor:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }

        .rich-text-editor ul {
            margin-left: 20px;
        }

        /* ========== AUTOCOMPLETADO DE CLIENTES ========== */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
            transition: background 0.15s;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .autocomplete-item-details {
            font-size: 11px;
            color: #7f8c8d;
            line-height: 1.3;
        }

        .autocomplete-empty {
            padding: 10px 12px;
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            font-size: 12px;
        }

        .autocomplete-count {
            padding: 6px 12px;
            background: #e8f4f8;
            border-bottom: 1px solid #bee5eb;
            font-size: 11px;
            color: #17a2b8;
            font-weight: 500;
        }

        /* Botón para ver todos los clientes */
        .btn-cliente-list {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            min-width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-cliente-list:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-cliente-list:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Header fijo -->
    <header class="header-fixed" id="main-header">
        <div class="header-content">
            <div class="logo-section">
                <h1>📄 Sistema TBAI</h1>
            </div>
            <nav class="nav-menu">
                <div class="dropdown dropdown-facturas">
                    <button class="btn-header" id="btn-gestion-facturas">
                        📊 Gestión de Facturas ▼
                    </button>
                    <div class="dropdown-content" id="dropdown-gestion">
                        <a onclick="clearForm()">🧹 Limpiar formulario</a>
                        <a onclick="loadSampleData()">📝 Cargar datos de ejemplo</a>
                        <a onclick="printInvoice()">🖨️ Imprimir factura</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn-header" id="btn-gestion-emisores">
                        🏢 Gestión de Emisores ▼
                    </button>
                    <div class="dropdown-content" id="dropdown-emisores">
                        <a onclick="showEmisoresManager()">📝 Gestionar emisores</a>
                        <a onclick="addNewEmisor()">➕ Añadir emisor</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn-header">
                        ⚙️ Herramientas ▼
                    </button>
                    <div class="dropdown-content">
                        <a onclick="openGridInNewTab()">📋 Ir al listado de facturas</a>
                        <a onclick="exportToExcel()">📈 Exportar a Excel</a>
                        <a onclick="openGoogleSheets()">📊 Abrir Google Sheets</a>
                        <a id="show-columns-btn" onclick="showColumnsMenu()" style="display: none;">👁️ Mostrar columnas ocultas</a>
                    </div>
                </div>
                <button class="btn-header primary" onclick="generateInvoice()">
                    ✨ Generar Factura
                </button>
            </nav>
        </div>
    </header>

    <!-- Contenedor de notificaciones -->
    <div class="notifications-container" id="notifications-container"></div>

    <div class="container">
        <h2>Nueva Factura</h2>
        
        <div class="main-layout">
            <!-- Formulario de entrada -->
            <div class="form-section">
                <h2>Datos de Factura</h2>
                
                <!-- Datos del Emisor -->
                <h3 style="margin-bottom: 8px; color: #34495e;">Datos del Emisor</h3>
                <div class="form-group">
                    <label for="emisor-nombre">Nombre/Razón Social</label>
                    <input type="text" id="emisor-nombre" value="" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisor-nif">NIF/CIF</label>
                        <input type="text" id="emisor-nif" value="" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="emisor-telefono">Teléfono</label>
                        <input type="text" id="emisor-telefono" value="" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="emisor-direccion">Dirección</label>
                    <input type="text" id="emisor-direccion" value="" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="emisor-cp">Código Postal</label>
                        <input type="text" id="emisor-cp" value="" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="emisor-ciudad">Ciudad</label>
                        <input type="text" id="emisor-ciudad" value="" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="emisor-provincia">Provincia</label>
                        <select id="emisor-provincia" disabled style="background: #f8f9fa;">
                            <option value="" selected>Seleccionar provincia...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Datos del Cliente -->
                <h3 style="margin: 10px 0 8px 0; color: #34495e;">Datos del Cliente</h3>
                <div class="form-group" style="position: relative;">
                    <label for="cliente-nombre">Nombre/Razón Social</label>
                    <div style="position: relative; display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="cliente-nombre" placeholder="Escriba un cliente nuevo o seleccione uno existente..." autocomplete="off" style="flex: 1;">
                        <button type="button" class="btn-cliente-list" onclick="toggleClientesList()" title="Ver todos los clientes">
                            📋
                        </button>
                    </div>
                    <div id="cliente-autocomplete" class="autocomplete-dropdown"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cliente-nif">NIF/CIF</label>
                        <input type="text" id="cliente-nif" placeholder="">
                    </div>
                    <div class="form-group">
                        <label for="cliente-email">Email</label>
                        <input type="email" id="cliente-email" placeholder="">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cliente-direccion">Dirección</label>
                    <input type="text" id="cliente-direccion" placeholder="">
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="cliente-cp">Código Postal</label>
                        <input type="text" id="cliente-cp" placeholder="">
                    </div>
                    <div class="form-group">
                        <label for="cliente-ciudad">Ciudad</label>
                        <input type="text" id="cliente-ciudad" placeholder="">
                    </div>
                    <div class="form-group">
                        <label for="cliente-provincia">Provincia</label>
                        <input type="text" id="cliente-provincia" placeholder="">
                    </div>
                </div>
                
                <!-- Datos de la Factura -->
                <h3 style="margin: 10px 0 8px 0; color: #34495e;">Información de Factura</h3>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="factura-serie">Serie</label>
                        <input type="text" id="factura-serie" placeholder="DFA_2025-005" value="DFA_2025-005">
                    </div>
                    <div class="form-group">
                        <label for="factura-numero">Número</label>
                        <input type="text" id="factura-numero" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="factura-fecha">Fecha</label>
                        <input type="text" id="factura-fecha" placeholder="dd/mm/yyyy">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="operacion-descripcion">Descripción de la Operación</label>
                    <textarea id="operacion-descripcion" rows="2" placeholder="Descripción detallada de la operación realizada..."></textarea>
                </div>

                <!-- Nuevo campo de texto libre con editor -->
                <div class="form-group">
                    <label for="texto-libre">Texto libre (aparecerá al final de la factura)</label>
                    
                    <!-- Barra de herramientas del editor -->
                    <div class="editor-toolbar">
                        <button type="button" id="btn-bold" class="editor-btn" onclick="formatText('bold')" title="Negrita (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button type="button" id="btn-italic" class="editor-btn" onclick="formatText('italic')" title="Cursiva (Ctrl+I)">
                            <em>I</em>
                        </button>
                        <button type="button" id="btn-underline" class="editor-btn" onclick="formatText('underline')" title="Subrayado (Ctrl+U)">
                            <u>U</u>
                        </button>
                        <span class="editor-separator">|</span>
                        <button type="button" class="editor-btn" onclick="decreaseFontSize()" title="Reducir tamaño">
                            A−
                        </button>
                        <button type="button" class="editor-btn" onclick="increaseFontSize()" title="Aumentar tamaño">
                            A+
                        </button>
                        <span class="editor-separator">|</span>
                        <button type="button" id="btn-list" class="editor-btn" onclick="formatText('insertUnorderedList')" title="Lista">
                            •••
                        </button>
                        <button type="button" class="editor-btn" onclick="clearFormatting()" title="Limpiar formato">
                            ✕
                        </button>
                    </div>
                    
                    <!-- Editor de texto enriquecido -->
                    <div id="texto-libre" 
                         contenteditable="true" 
                         class="rich-text-editor"
                         placeholder="Texto adicional que aparecerá en la parte inferior izquierda de la factura..."
                         data-placeholder="Texto adicional que aparecerá en la parte inferior izquierda de la factura...">
                    </div>
                    <textarea id="texto-libre-hidden" style="display:none;"></textarea>
                </div>
                
                <!-- Conceptos/Items -->
                <div class="items-section">
                    <h3 style="margin-bottom: 8px; color: #34495e;">Conceptos</h3>
                    <div class="item-row item-header">
                        <div>Descripción</div>
                        <div>Cantidad</div>
                        <div>Precio</div>
                        <div>IVA %</div>
                        <div>Total</div>
                        <div></div>
                    </div>
                    <div id="items-container">
                        <!-- Los items se añadirán dinámicamente aquí -->
                    </div>
                    <button type="button" class="btn-add" onclick="addItem()">+ Añadir Concepto</button>
                </div>
                
                <!-- Indicador de estado de guardado -->
                <div id="save-status" style="margin-top: 20px; text-align: center; font-size: 14px; color: #666; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <span style="color: #3498db;">💾 Se preguntará si desea guardar al generar la factura</span>
                </div>
            </div>
            
            <!-- Vista previa de la factura -->
            <div class="preview-section">
                <div class="invoice-preview" id="invoice-preview">
                    <div style="text-align: center; color: #95a5a6; padding: 100px 0;">
                        <h3>Vista Previa de Factura</h3>
                        <p>Complete el formulario para ver la factura</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botón de imprimir se muestra dinámicamente en el header cuando hay factura -->
    </div>

    <!-- Grid de facturas (oculto por defecto) -->
    <div id="grid-section" style="display: none; padding: 10px;">
        <div class="container" style="max-width: 98%; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: #2c3e50; margin: 0;">📊 Gestión de Facturas</h2>
                <button type="button" class="btn btn-secondary" onclick="toggleGridView()">❌ Cerrar</button>
            </div>
            
            <div class="toolbar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <div class="search-box" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                    <div style="position: relative; width: 100%; max-width: 400px;">
                        <input type="text" id="searchInput" placeholder="🔍 Buscar en todas las columnas..." style="padding: 10px 40px 10px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%; transition: all 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#e0e0e0'">
                        <button type="button" id="clearSearchBtn" onclick="clearSearch()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 5px 8px; display: none; transition: color 0.2s; line-height: 1;" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='#999'" title="Limpiar búsqueda">×</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="selectedCountGrid" style="font-size: 14px; color: #666;">0 filas seleccionadas</span>
                    <button class="btn btn-warning" id="clearAllFiltersBtn" onclick="clearAllFilters()" style="display: none;">🧹 Limpiar Filtros</button>
                    <button class="btn btn-warning" id="saveSortBtn" onclick="saveSortToSheets()" style="display: none;">💾 Guardar Orden en Sheets</button>
                    <button class="btn btn-secondary" id="showAllColumnsBtn" onclick="showAllColumns()" style="display: none;">👁️ Mostrar Todas las Columnas</button>
                    <button class="btn btn-secondary" id="ungroupBtn" onclick="ungroupData()" style="display: none;">📊 Desagrupar</button>
                    <button class="btn btn-success" onclick="loadSelectedInvoice()">📄 Cargar Seleccionada</button>
                    <button class="btn btn-primary" onclick="exportToExcel()">📈 Exportar Excel</button>
                    <button class="btn btn-delete" id="deleteSelectedBtn" onclick="deleteSelectedInvoices()" style="display: none;">🗑️ Eliminar Seleccionadas</button>
                    <button class="btn btn-primary" onclick="refreshGrid()">🔄 Actualizar</button>
                </div>
            </div>

            <div class="table-container">
                <div id="loading" class="loading" style="text-align: center; padding: 40px; color: #7f8c8d;">Cargando facturas...</div>
                <table id="invoicesGrid" style="display: none; width: 100%; border-collapse: collapse;">
                    <thead id="gridHeader" style="background: #34495e; color: white; position: sticky; top: 0; z-index: 10;"></thead>
                    <tbody id="gridBody"></tbody>
                </table>
            </div>

            <!-- Barra de estadísticas -->
            <div class="stats-bar" id="statsBar" style="display: flex; visibility: visible; background: #f8f9fa; padding: 15px; border-top: 2px solid #e0e0e0; margin-top: 10px; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                <div class="stat-item" style="text-align: center; min-width: 150px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="stat-label" style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Total Facturas</div>
                    <div class="stat-value" id="statTotalFacturas" style="font-size: 18px; color: #2c3e50; font-weight: bold;">0</div>
                </div>
                <div class="stat-item" style="text-align: center; min-width: 150px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="stat-label" style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Base Imponible Total</div>
                    <div class="stat-value" id="statBaseTotal" style="font-size: 18px; color: #27ae60; font-weight: bold;">0,00 €</div>
                </div>
                <div class="stat-item" style="text-align: center; min-width: 150px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="stat-label" style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">IVA Total</div>
                    <div class="stat-value" id="statIvaTotal" style="font-size: 18px; color: #e67e22; font-weight: bold;">0,00 €</div>
                </div>
                <div class="stat-item" style="text-align: center; min-width: 150px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="stat-label" style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Total Facturado</div>
                    <div class="stat-value" id="statTotalFacturado" style="font-size: 18px; color: #3498db; font-weight: bold;">0,00 €</div>
                </div>
                <div class="stat-item" style="text-align: center; min-width: 150px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="stat-label" style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 600;">Factura Promedio</div>
                    <div class="stat-value" id="statPromedio" style="font-size: 18px; color: #9b59b6; font-weight: bold;">0,00 €</div>
                </div>
            </div>

            <div class="status-bar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1; font-size: 14px; color: #7f8c8d;">
                <div id="statusText">0 facturas cargadas</div>
                <div style="display: flex; gap: 20px;">
                    <div id="selectedInfo">Ninguna fila seleccionada</div>
                    <div id="loadTime" style="color: #27ae60; font-style: italic;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Suprimir errores de source maps de Google Sheets
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('sourcemap') && message.includes('google.com')) return;
            originalError.apply(console, args);
        };
        
        // Establecer fecha actual por defecto en formato español
        try {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateString = `${day}/${month}/${year}`;
            document.getElementById('factura-fecha').value = dateString;
        } catch (error) {
            console.error('Error al establecer fecha:', error);
        }

        let itemCount = 0;

        // Cache de elementos DOM frecuentemente accedidos
        const domCache = {
            get: function(id) {
                if (!this[id]) this[id] = document.getElementById(id);
                return this[id];
            },
            clear: function() {
                Object.keys(this).forEach(key => {
                    if (key !== 'get' && key !== 'clear') delete this[key];
                });
            }
        };

        // Sistema de Notificaciones
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notifications-container');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            const titleMap = {
                success: 'Éxito',
                error: 'Error',
                warning: 'Advertencia',
                info: 'Información'
            };

            notification.innerHTML = `
                <div class="notification-header">
                    <span class="notification-icon">${iconMap[type]}</span>
                    <span>${titleMap[type]}</span>
                    <button class="notification-close" onclick="closeNotification(this)">×</button>
                </div>
                <div class="notification-body">${message}</div>
            `;

            container.appendChild(notification);

            // Animar entrada
            setTimeout(() => notification.classList.add('show'), 10);

            // Auto-cerrar
            if (duration > 0) {
                setTimeout(() => closeNotification(notification.querySelector('.notification-close')), duration);
            }

            return notification;
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // 1. Añadir función para limpiar formato de número español a número JS
        function parseNumberES(str) {
            if (typeof str === 'number') return str;
            if (typeof str !== 'string') return 0;
            
            // Limpiar espacios en blanco
            str = str.trim();
            
            // Si está vacío, retornar 0
            if (str === '') return 0;
            
            // Remover símbolo de euro si existe
            str = str.replace(/€/g, '').trim();
            
            // Manejar formato español (1.234,56) y formato americano (1,234.56)
            // Si tiene punto y coma, asumimos formato español
            if (str.includes(',') && str.includes('.')) {
                // Formato español: puntos para miles, coma para decimales
                if (str.lastIndexOf(',') > str.lastIndexOf('.')) {
                    str = str.replace(/\./g, '').replace(',', '.');
                } else {
                    // Formato americano: comas para miles, punto para decimales
                    str = str.replace(/,/g, '');
                }
            } else if (str.includes(',')) {
                // Solo tiene comas, podría ser decimal español
                // Si la coma está cerca del final (últimos 3 caracteres), es decimal
                const comaPos = str.lastIndexOf(',');
                if (str.length - comaPos <= 3) {
                    str = str.replace(',', '.');
                } else {
                    // Es separador de miles
                    str = str.replace(/,/g, '');
                }
            }
            
            return parseFloat(str) || 0;
        }

        function addItem() {
            itemCount++;
            const container = document.getElementById('items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.id = `item-${itemCount}`;
            itemDiv.innerHTML = `
                <input type="text" id="desc-${itemCount}" placeholder="Descripción del servicio/producto">
                <input type="text" id="qty-${itemCount}" placeholder="1" onchange="calculateItemTotal(${itemCount})" onblur="this.value=formatNumber(parseNumberES(this.value))" style="text-align: right;">
                <input type="text" id="price-${itemCount}" placeholder="0,00" onchange="calculateItemTotal(${itemCount})" onblur="this.value=formatNumber(parseNumberES(this.value))" style="text-align: right;">
                <select id="iva-${itemCount}" onchange="calculateItemTotal(${itemCount})">
                    <option value="21">21%</option>
                    <option value="10">10%</option>
                    <option value="4">4%</option>
                    <option value="0">0%</option>
                </select>
                <input type="text" id="total-${itemCount}" placeholder="0,00" readonly style="background: #f8f9fa; text-align: right;">
                <button type="button" class="btn-remove" onclick="removeItem(${itemCount})">×</button>
            `;
            container.appendChild(itemDiv);

            // Formatear si hay valores por defecto
            const qtyInput = document.getElementById(`qty-${itemCount}`);
            const priceInput = document.getElementById(`price-${itemCount}`);
            const totalInput = document.getElementById(`total-${itemCount}`);
            if (qtyInput.value) qtyInput.value = formatNumber(parseNumberES(qtyInput.value));
            if (priceInput.value) priceInput.value = formatNumber(parseNumberES(priceInput.value));
            if (totalInput.value) totalInput.value = formatNumber(parseNumberES(totalInput.value));
        }

        function removeItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.remove();
            }
        }

        function calculateItemTotal(id) {
            const qtyValue = document.getElementById(`qty-${id}`).value;
            const priceValue = document.getElementById(`price-${id}`).value;
            const qty = parseNumberES(qtyValue);
            const price = parseNumberES(priceValue);
            const ivaValue = document.getElementById(`iva-${id}`).value;
            const iva = ivaValue !== '' ? parseFloat(ivaValue) : 21;
            const subtotal = qty * price;
            const total = subtotal * (1 + iva / 100);
            document.getElementById(`total-${id}`).value = formatNumber(total);
        }

        function clearForm() {
            if (!confirm('¿Está seguro de que desea limpiar todo el formulario?')) return;
            
            document.querySelectorAll('input[type="text"]:not([readonly]), input[type="number"], input[type="email"]').forEach(input => {
                if (!['factura-fecha', 'factura-serie'].includes(input.id)) input.value = '';
            });
            
            domCache.get('items-container').innerHTML = '';
            domCache.get('invoice-preview').innerHTML = `
                <div style="text-align: center; color: #95a5a6; padding: 100px 0;">
                    <h3>Vista Previa de Factura</h3>
                    <p>Complete el formulario para ver la factura</p>
                </div>
            `;
            hidePrintButton();
            itemCount = 0;
        }

        function validateForm() {
            const requiredFields = ['cliente-nombre', 'cliente-nif', 'cliente-direccion', 'cliente-cp', 'cliente-ciudad', 'factura-numero'];
            
            const isValid = requiredFields.every(fieldId => {
                const field = domCache.get(fieldId);
                const valid = !!field.value.trim();
                field.classList.toggle('error', !valid);
                return valid;
            });
            
            if (!isValid) return false;
            
            const items = domCache.get('items-container').querySelectorAll('.item-row');
            if (items.length === 0) {
                showNotification('Debe añadir al menos un concepto a la factura', 'warning');
                return false;
            }
            
            return true;
        }

        function generateInvoice(skipSavePrompt = false) {
            if (!validateForm()) {
                showNotification('Por favor, complete todos los campos obligatorios', 'error');
                return;
            }
            
            // Función auxiliar para obtener datos de un grupo
            const getFormData = (fields) => {
                const data = {};
                fields.forEach(field => {
                    data[field] = domCache.get(`${fields.prefix}-${field}`)?.value || '';
                });
                return data;
            };
            
            // Recopilar datos
            const invoiceData = {
                emisor: {
                    nombre: domCache.get('emisor-nombre').value,
                    nif: domCache.get('emisor-nif').value,
                    telefono: domCache.get('emisor-telefono').value,
                    direccion: domCache.get('emisor-direccion').value,
                    cp: domCache.get('emisor-cp').value,
                    ciudad: domCache.get('emisor-ciudad').value,
                    provincia: domCache.get('emisor-provincia').value
                },
                cliente: {
                    nombre: domCache.get('cliente-nombre').value,
                    nif: domCache.get('cliente-nif').value,
                    email: domCache.get('cliente-email').value,
                    direccion: domCache.get('cliente-direccion').value,
                    cp: domCache.get('cliente-cp').value,
                    ciudad: domCache.get('cliente-ciudad').value,
                    provincia: domCache.get('cliente-provincia').value
                },
                factura: {
                    serie: domCache.get('factura-serie').value,
                    numero: domCache.get('factura-numero').value,
                    fecha: domCache.get('factura-fecha').value,
                    descripcionOperacion: domCache.get('operacion-descripcion').value,
                    textoLibre: domCache.get('texto-libre').innerHTML || ''
                },
                items: []
            };
            
            // Recopilar items
            const items = document.querySelectorAll('#items-container .item-row');
            let subtotal = 0;
            let totalIVA = 0;
            
            items.forEach((item) => {
                const id = item.id.split('-')[1];
                const desc = document.getElementById(`desc-${id}`).value;
                const qtyValue = document.getElementById(`qty-${id}`).value;
                const priceValue = document.getElementById(`price-${id}`).value;
                const qty = qtyValue ? parseNumberES(qtyValue) : 0;
                const price = priceValue ? parseNumberES(priceValue) : 0;
                const ivaValue = document.getElementById(`iva-${id}`).value;
                const iva = ivaValue !== '' ? parseFloat(ivaValue) : 21;
                
                if (desc) {
                    const itemSubtotal = qty * price;
                    const itemIVA = itemSubtotal * (iva / 100);
                    subtotal += itemSubtotal;
                    totalIVA += itemIVA;
                    
                    invoiceData.items.push({
                        descripcion: desc,
                        cantidad: qty,
                        precio: price,
                        iva: iva,
                        subtotal: itemSubtotal,
                        total: itemSubtotal + itemIVA
                    });
                }
            });
            
            invoiceData.totales = {
                subtotal: subtotal,
                iva: totalIVA,
                total: subtotal + totalIVA
            };
            
            // Generar vista previa
            renderInvoice(invoiceData);
            
            // Generar QR TBAI
            generateTBAIQR(invoiceData);
            
            // Mostrar botones de acción
            // Mostrar botón de imprimir en el header
            showPrintButton();
            
            // Preguntar si desea guardar la factura (solo si no se especifica skipSavePrompt)
            if (!skipSavePrompt) {
                setTimeout(() => {
                    const mensaje = '¿Desea guardar esta factura en Google Sheets?\n\n' +
                                   '⚠️ Si ya existe (mismo Número), solo se actualizará si hay modificaciones.';
                    if (confirm(mensaje)) {
                        saveInvoiceAutomatically(invoiceData);
                    }
                }, 500); // Pequeño delay para que se vea primero la factura
            }
        }

        function renderInvoice(data) {
            // Procesar fecha usando la función auxiliar
            const fechaData = processFechaHora(data.factura.fecha);
            const fechaExpedicion = fechaData.objeto;
            const fechaFormateada = fechaData.solo_fecha; // Solo mostrar fecha sin hora
            const fechaTBAI = `${String(fechaExpedicion.getDate()).padStart(2, '0')}${String(fechaExpedicion.getMonth() + 1).padStart(2, '0')}${String(fechaExpedicion.getFullYear()).slice(2)}`;

            let itemsHTML = '';
            data.items.forEach(item => {
                // Si cantidad es 0 o 1, y precio es 0, dejar campos en blanco
                const shouldBeBlank = (item.cantidad === 0 || item.cantidad === 1) && item.precio === 0;
                
                itemsHTML += `
                    <tr style="font-size: 8pt;">
                        <td style="border: 1px solid #000; padding: 5px; text-align: left;">${item.descripcion}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${shouldBeBlank ? '' : formatNumber(item.cantidad)}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">${shouldBeBlank ? '' : formatNumber(item.precio)}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;"></td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">${shouldBeBlank ? '' : formatNumber(item.subtotal)}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${shouldBeBlank ? '' : item.iva}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">${shouldBeBlank ? '' : formatNumber(item.total)}</td>
                    </tr>
                `;
            });

            // Mejorar el resumen de IVA para manejar diferentes tipos de IVA incluido 0%
            const ivaSummary = {};
            let totalBase = 0;
            let totalIVAAmount = 0;
            
            data.items.forEach(item => {
                if (!ivaSummary[item.iva]) {
                    ivaSummary[item.iva] = { base: 0, iva: 0 };
                }
                ivaSummary[item.iva].base += item.subtotal;
                ivaSummary[item.iva].iva += item.subtotal * (item.iva / 100);
                totalBase += item.subtotal;
                totalIVAAmount += item.subtotal * (item.iva / 100);
            });

            // Generar HTML del resumen de IVA
            let ivaSummaryHTML = '';
            Object.keys(ivaSummary).sort((a, b) => parseFloat(b) - parseFloat(a)).forEach(ivaRate => {
                const summary = ivaSummary[ivaRate];
                ivaSummaryHTML += `
                    <tr style="font-size: 8pt;">
                        <td style="padding: 5px; text-align: right; border: 1px solid #000;">${formatNumber(summary.base)}</td>
                        <td style="padding: 5px; text-align: center; border: 1px solid #000;">${ivaRate}% &nbsp;&nbsp;&nbsp; ${formatNumber(summary.iva)}</td>
                        <td style="padding: 5px; text-align: center; border: 1px solid #000;">0,00 &nbsp;&nbsp;&nbsp; 0,00</td>
                        <td style="padding: 5px; text-align: right; border: 1px solid #000;">${formatNumber(summary.base + summary.iva)}</td>
                    </tr>
                `;
            });

            const html = `
                <div style="width: 21cm; min-height: 29.7cm; margin: 0 auto; padding: 1cm; font-family: Arial, sans-serif; font-size: 8pt; line-height: 1.2; background: white; box-sizing: border-box; position: relative;">

                    <!-- Top Section -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 style="font-size: 14pt; margin: 0 0 8px 0; font-weight: bold; color: #000; border: none; padding-bottom: 0; letter-spacing: 0.5px;">FAKTURA/FACTURA</h2>
                        <table style="margin: 0 auto; text-align: left; font-size: 9pt; border-spacing: 0; border-collapse: collapse;">
                            <tr><td style="padding: 2px 120px 2px 0; font-weight: normal;">Saila/Serie</td><td style="padding: 2px 0; font-weight: normal;">${data.factura.serie}</td></tr>
                            <tr><td style="padding: 2px 120px 2px 0; font-weight: normal;">Faktura zenbakia/Número de Factura</td><td style="padding: 2px 0; font-weight: normal;">${data.factura.numero}</td></tr>
                            <tr><td style="padding: 2px 120px 2px 0; font-weight: normal;">Jaulkitze data/Fecha expedición</td><td style="padding: 2px 0; font-weight: normal;">${fechaFormateada}</td></tr>
                            <tr><td style="padding: 2px 120px 2px 0; font-weight: normal;">Eragiketaren data/Fecha Operación</td><td style="padding: 2px 0; font-weight: normal;">${fechaFormateada}</td></tr>
                            <tr><td style="padding: 2px 120px 2px 0; font-weight: normal;">Mota/Tipo</td><td style="padding: 2px 0; font-weight: normal;">Osoa/Completa</td></tr>
                        </table>
                    </div>

                    <!-- Issuer and Client Section -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; gap: 20px;">
                        <div style="width: 48%; background: #E8E8E8; padding: 15px; border: none;">
                            <div style="color: #D1006C; font-weight: bold; margin-bottom: 5px; font-size: 10pt;">JAULKITZAILEA/EMISOR(A)</div>
                            <div style="margin-bottom: 3px; font-size: 9pt;"><strong>${data.emisor.nif} - ${data.emisor.nombre}</strong></div>
                            <div style="margin-bottom: 2px; font-size: 9pt;">${data.emisor.direccion}</div>
                            <div style="font-size: 9pt;">${data.emisor.cp} ${data.emisor.ciudad} (${data.emisor.provincia})</div>
                        </div>
                        <div style="width: 48%; background: #E8E8E8; padding: 15px; border: none;">
                            <div style="color: #D1006C; font-weight: bold; margin-bottom: 5px; font-size: 10pt;">BEZEROA/CLIENTE</div>
                            <div style="margin-bottom: 3px; font-size: 9pt;"><strong>${data.cliente.nif} - ${data.cliente.nombre}</strong></div>
                            <div style="margin-bottom: 2px; font-size: 9pt;">${data.cliente.direccion}</div>
                            <div style="font-size: 9pt;">${data.cliente.cp} ${data.cliente.ciudad} (${data.cliente.provincia})</div>
                        </div>
                    </div>
                    
                    <!-- Operation Description -->
                    <div style="border: 1px solid #000; padding: 10px 15px; margin-bottom: 15px; font-size: 9pt;">
                        <div style="font-weight: normal; margin-bottom: 3px;">Eragiketaren deskribapena / Descripción operación</div>
                        ${data.factura.descripcionOperacion || data.items.map(item => item.descripcion).join(', ')}
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 8pt;">
                        <thead>
                            <tr style="background: #d42574; color: white; font-weight: bold;">
                                <th style="border: 1px solid #000; padding: 5px 10px; text-align: center; font-size: 9pt; white-space: nowrap;">Deskribapena<br>Detalle</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">Kopurua<br>Cantidad</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">Prezioa<br>Precio €</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">Dtua<br>Dto €</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">Oinarria<br>Base €</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">%BEZ B.E.<br>/ IVA %</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; font-size: 9pt; white-space: nowrap;">Guztira<br>Total €</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>

                    <!-- Summary Table centered below main table -->
                    <div style="margin-top: 25px; display: flex; justify-content: center;">
                        <table style="width: 80%; border-collapse: collapse; font-size: 8pt;">
                            <thead>
                                <tr style="background: #d42574; color: white; font-weight: bold;">
                                    <th style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 8pt;">Oinarra / Base €</th>
                                    <th style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 8pt;">BEZa eta beste zerga batzuk / IVA y otros impuestos</th>
                                    <th style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 8pt;">Baliokidetasun errekargua / Recargo de equivalencia</th>
                                    <th style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 8pt;">Guztira / Total €</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ivaSummaryHTML}
                            </tbody>
                        </table>
                    </div>

                    <!-- Bottom Section: QR Code and Totals -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 25px; gap: 20px;">
                        <!-- Left side: QR Code -->
                        <div style="width: auto;">
                            <div id="qrcode-tbai" style="display: inline-block; border: 2px solid #000; padding: 5px; line-height: 0; background: white;"></div>
                        </div>

                        <!-- Right side: Final Totals -->
                        <div style="width: 45%; text-align: left; margin-left: auto;">
                            <div style="font-size: 9pt; line-height: 1.6;">
                                <div style="margin-bottom: 3px; display: flex; justify-content: space-between; white-space: nowrap;">
                                    <span>Zerga-oinarria/Base imponible</span>
                                    <span style="font-weight: bold; margin-left: 20px;">${formatNumber(data.totales.subtotal)} €</span>
                                </div>
                                <div style="margin-bottom: 3px; display: flex; justify-content: space-between; white-space: nowrap;">
                                    <span>BEZaren kuota/Cuota IVA</span>
                                    <span style="font-weight: bold; margin-left: 20px;">${formatNumber(data.totales.iva)} €</span>
                                </div>
                                <div style="font-weight: bold; font-size: 10pt; margin-top: 8px; display: flex; justify-content: space-between; white-space: nowrap;">
                                    <span>Zenbatekoa, guztira/Importe total</span>
                                    <span style="margin-left: 20px;">${formatNumber(data.totales.total)} €</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Boxes Container - Full Width -->
                    <div style="display: flex; gap: 10px; align-items: stretch; justify-content: space-between; margin-top: 15px;">
                        <!-- TBAI Code -->
                        <div style="border: 1px solid #000; padding: 8px 12px; font-size: 6pt; text-align: center; font-family: monospace; flex: 1; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <strong id="tbai-code" style="font-size: 6pt; word-break: break-all;">TBAI-${data.emisor.nif}-${fechaTBAI}-${(Math.random().toString(36)+'00000000000000000').slice(2, 15).toUpperCase()}-${Math.floor(Math.random()*900)+100}</strong>
                                <br>
                                <div class="tbai-url" style="font-size: 5pt; margin-top: 2px; color: #000; cursor: pointer;" onclick="window.open('https://ticketbai.araba.eus/tbai/qrtbai/', '_blank')">
                                    <span class="web-only">🔗 </span>ticketbai.araba.eus/tbai/qrtbai/
                                </div>
                            </div>
                        </div>

                        <!-- Verification Code -->
                        <div style="border: 1px solid #000; padding: 8px 12px; font-size: 6pt; text-align: center; flex: 1;">
                            <div style="margin-bottom: 2px; font-weight: normal; font-size: 6pt;">Egiaztapen kodea / Código de verificación</div>
                            <div id="verification-code" style="font-family: monospace; font-size: 7pt; font-weight: bold;">${generateVerificationCode()}</div>
                        </div>

                        <!-- Verification URL -->
                        <div style="border: 1px solid #000; padding: 8px 12px; font-size: 6pt; text-align: center; flex: 1;">
                            <div style="margin-bottom: 2px; font-weight: normal; font-size: 6pt;">Egiaztatzeko helbidea / Dirección de comprobación</div>
                            <div class="verification-url" style="font-size: 5pt; color: #000; word-break: break-all; cursor: pointer;" onclick="window.open('https://egoitza.araba.eus/izapidetu/sgvfcove/', '_blank')">
                                <span class="web-only">🔗 </span>egoitza.araba.eus/izapidetu/sgvfcove/
                            </div>
                        </div>
                    </div>
                    
                    <!-- Texto libre del usuario -->
                    <div style="margin-top: 15px; font-size: 8pt; text-align: left;">
                        <div id="texto-libre-factura" style="line-height: 1.2;"></div>
                    </div>
                    
                    <!-- Footer con texto legal y número de página -->
                    <div style="position: absolute; bottom: 1cm; left: 1cm; right: 1cm;">
                        <div id="disclaimer-legal" style="font-size: 7pt; text-align: justify; line-height: 1.1; margin-bottom: 10px;">
                            <strong>Eragiketaren zenbatekoa 1.000 euro edo hortik gorakoa denez, faktura hori ezin izango da eskudirutan ordaindu (urriaren 29ko 7/2012 Legearen 7. art.)/El importe de la operación es igual o superior a 1.000 euros por lo que esta factura no podrá ser abonada en efectivo (art.7 Ley 7/2012, de 29 de octubre)</strong>
                        </div>
                        
                        <div style="text-align: center; font-size: 8pt;">
                            1 (e)tik 1 / 1 de 1
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('invoice-preview').innerHTML = html;
            
            // Añadir texto libre si existe
            const textoLibreElement = document.getElementById('texto-libre-factura');
            if (data.factura.textoLibre && textoLibreElement) {
                // El texto ya viene con formato HTML del editor
                textoLibreElement.innerHTML = data.factura.textoLibre;
            }
            
            // OCULTAR EL TEXTO LEGAL SI EL TOTAL ES MENOR A 1000
            if (data.totales.total < 1000) {
                const disclaimer = document.getElementById('disclaimer-legal');
                if (disclaimer) disclaimer.style.display = 'none';
            }
            
            // URL de verificación ya se gestiona con enlaces directos
        }

        function formatNumber(number) {
            // Formato español: xx.xxx,xx
            return number.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
                useGrouping: true
            });
        }
        
        function formatNumberForSheet(number) {
            // Para guardar en Google Sheets: número puro con punto decimal
            return Number(number).toFixed(2);
        }

        // ========== FUNCIONES DEL EDITOR DE TEXTO ENRIQUECIDO ==========
        let currentFontSize = 3; // Tamaño base (1=10px, 2=13px, 3=16px, 4=18px, 5=24px, 6=32px, 7=48px)
        
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('texto-libre').focus();
            updateToolbarState();
        }
        
        function updateToolbarState() {
            // Actualizar estado de los botones según el formato aplicado
            const isBold = document.queryCommandState('bold');
            const isItalic = document.queryCommandState('italic');
            const isUnderline = document.queryCommandState('underline');
            const isList = document.queryCommandState('insertUnorderedList');
            
            // Actualizar clases de los botones
            const btnBold = document.getElementById('btn-bold');
            const btnItalic = document.getElementById('btn-italic');
            const btnUnderline = document.getElementById('btn-underline');
            const btnList = document.getElementById('btn-list');
            
            if (btnBold) {
                btnBold.classList.toggle('active', isBold);
            }
            if (btnItalic) {
                btnItalic.classList.toggle('active', isItalic);
            }
            if (btnUnderline) {
                btnUnderline.classList.toggle('active', isUnderline);
            }
            if (btnList) {
                btnList.classList.toggle('active', isList);
            }
        }

        function increaseFontSize() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            // Obtener el tamaño actual del texto seleccionado
            const parentElement = selection.anchorNode.parentElement;
            const currentSize = getFontSizeLevel(parentElement);
            
            // Incrementar (máximo 7)
            const newSize = Math.min(currentSize + 1, 7);
            document.execCommand('fontSize', false, newSize.toString());
            document.getElementById('texto-libre').focus();
            updateToolbarState();
        }

        function decreaseFontSize() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            // Obtener el tamaño actual del texto seleccionado
            const parentElement = selection.anchorNode.parentElement;
            const currentSize = getFontSizeLevel(parentElement);
            
            // Decrementar (mínimo 1)
            const newSize = Math.max(currentSize - 1, 1);
            document.execCommand('fontSize', false, newSize.toString());
            document.getElementById('texto-libre').focus();
            updateToolbarState();
        }

        function getFontSizeLevel(element) {
            // Intentar obtener el nivel de tamaño de fuente del elemento
            if (element && element.tagName === 'FONT') {
                const size = parseInt(element.getAttribute('size'));
                if (!isNaN(size)) return size;
            }
            
            // Si no hay tamaño específico, devolver el tamaño base
            return 3;
        }

        function clearFormatting() {
            document.execCommand('removeFormat', false, null);
            document.getElementById('texto-libre').focus();
            updateToolbarState();
        }

        // Sincronizar contenido del editor con campo hidden para el envío
        function syncEditorContent() {
            const editor = document.getElementById('texto-libre');
            const hidden = document.getElementById('texto-libre-hidden');
            if (editor && hidden) {
                hidden.value = editor.innerHTML;
            }
        }

        // Atajos de teclado para el editor
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('texto-libre');
            if (editor) {
                editor.addEventListener('keydown', (e) => {
                    // Ctrl+B = Negrita
                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        formatText('bold');
                    }
                    // Ctrl+I = Cursiva
                    if (e.ctrlKey && e.key === 'i') {
                        e.preventDefault();
                        formatText('italic');
                    }
                    // Ctrl+U = Subrayado
                    if (e.ctrlKey && e.key === 'u') {
                        e.preventDefault();
                        formatText('underline');
                    }
                });
                
                // Actualizar estado de la barra al mover el cursor o seleccionar texto
                editor.addEventListener('keyup', updateToolbarState);
                editor.addEventListener('mouseup', updateToolbarState);
                editor.addEventListener('click', updateToolbarState);
                
                // Sincronizar al escribir
                editor.addEventListener('input', syncEditorContent);
            }
        });

        // ========== SISTEMA DE AUTOCOMPLETADO DE CLIENTES ==========
        let clientesCache = [];
        let autoCompleteDebounceTimer = null;

        function loadClientesForAutocomplete() {
            if (!invoicesData || invoicesData.length === 0) return;
            
            // Debug: mostrar todas las columnas disponibles
            if (invoicesData.length > 0) {
                console.log('=== COLUMNAS DISPONIBLES EN GOOGLE SHEETS ===');
                console.log(Object.keys(invoicesData[0]));
                console.log('=== EJEMPLO PRIMERA FACTURA ===');
                console.log(invoicesData[0]);
            }
            
            // Extraer clientes únicos
            const clientesMap = new Map();
            invoicesData.forEach(invoice => {
                const nombre = invoice['Cliente'];
                if (nombre && !clientesMap.has(nombre)) {
                    clientesMap.set(nombre, {
                        nombre: nombre,
                        nif: invoice['NIF'] || invoice['NIF Cliente'] || '',
                        direccion: invoice['Dirección'] || invoice['Dirección Cliente'] || '',
                        cp: invoice['CP'] || invoice['CP Cliente'] || '',
                        ciudad: invoice['Ciudad'] || invoice['Ciudad Cliente'] || '',
                        provincia: invoice['Provincia'] || invoice['Provincia Cliente'] || '',
                        email: invoice['Email'] || invoice['Email Cliente'] || ''
                    });
                }
            });
            
            clientesCache = Array.from(clientesMap.values());
            
            // Debug: mostrar en consola los clientes cargados
            console.log('=== CLIENTES EXTRAÍDOS ===');
            console.log('Total clientes:', clientesCache.length);
            if (clientesCache.length > 0) {
                console.log('Ejemplo primer cliente:', clientesCache[0]);
            }
        }

        function showAutocomplete(searchText) {
            const dropdown = document.getElementById('cliente-autocomplete');
            if (!dropdown) return;
            
            if (!searchText || searchText.length < 2) {
                dropdown.classList.remove('show');
                return;
            }
            
            // Filtrar clientes
            const searchLower = searchText.toLowerCase();
            const matches = clientesCache.filter(cliente => 
                cliente.nombre.toLowerCase().includes(searchLower) ||
                (cliente.nif && cliente.nif.toLowerCase().includes(searchLower))
            );
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-empty">No se encontraron clientes</div>';
                dropdown.classList.add('show');
                return;
            }
            
            let html = `<div class="autocomplete-count">📋 ${matches.length} cliente${matches.length > 1 ? 's' : ''} encontrado${matches.length > 1 ? 's' : ''}</div>`;
            
            matches.slice(0, 10).forEach(cliente => {
                html += `
                    <div class="autocomplete-item" onclick="selectCliente('${cliente.nombre.replace(/'/g, "\\'")}')">
                        <div class="autocomplete-item-name">${cliente.nombre}</div>
                        <div class="autocomplete-item-details">
                            ${cliente.nif ? `${cliente.nif} • ` : ''}${cliente.ciudad || ''}${cliente.provincia ? ` (${cliente.provincia})` : ''}
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        }

        function toggleClientesList() {
            const dropdown = document.getElementById('cliente-autocomplete');
            if (!dropdown) return;
            
            // Si ya está visible, ocultarlo
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                return;
            }
            
            // Si no hay clientes cargados, cargarlos automáticamente
            if (clientesCache.length === 0) {
                loadClientesFromSheets();
                return;
            }
            
            // Mostrar TODOS los clientes
            displayAllClientes();
        }

        function loadClientesFromSheets() {
            const dropdown = document.getElementById('cliente-autocomplete');
            if (!dropdown) return;
            
            // Mostrar mensaje de carga
            dropdown.innerHTML = '<div class="autocomplete-count">⏳ Cargando clientes...</div>';
            dropdown.classList.add('show');
            
            // Cargar facturas desde Google Sheets
            fetch(WEB_APP_URL + '?action=read')
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success' && data.data && data.data.length > 0) {
                        invoicesData = data.data;
                        
                        // Extraer clientes únicos
                        loadClientesForAutocomplete();
                        
                        // Mostrar los clientes
                        displayAllClientes();
                        
                        showNotification(`✅ ${clientesCache.length} cliente${clientesCache.length > 1 ? 's' : ''} cargado${clientesCache.length > 1 ? 's' : ''}`, 'success', 3000);
                    } else {
                        dropdown.innerHTML = '<div class="autocomplete-empty">No se encontraron facturas en Google Sheets</div>';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar clientes:', error);
                    dropdown.innerHTML = '<div class="autocomplete-empty">Error al cargar clientes. Verifique la conexión.</div>';
                    showNotification('Error al cargar clientes desde Google Sheets', 'error', 5000);
                });
        }

        function displayAllClientes() {
            const dropdown = document.getElementById('cliente-autocomplete');
            if (!dropdown) return;
            
            if (clientesCache.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-empty">No hay clientes disponibles</div>';
                dropdown.classList.add('show');
                return;
            }
            
            // Mostrar TODOS los clientes
            let html = `<div class="autocomplete-count">📋 ${clientesCache.length} cliente${clientesCache.length > 1 ? 's' : ''} disponible${clientesCache.length > 1 ? 's' : ''}</div>`;
            
            // Ordenar clientes alfabéticamente
            const sortedClientes = [...clientesCache].sort((a, b) => 
                a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
            );
            
            // Mostrar todos (máximo 50 para no saturar)
            sortedClientes.slice(0, 50).forEach(cliente => {
                html += `
                    <div class="autocomplete-item" onclick="selectCliente('${cliente.nombre.replace(/'/g, "\\'")}')">
                        <div class="autocomplete-item-name">${cliente.nombre}</div>
                        <div class="autocomplete-item-details">
                            ${cliente.nif ? `${cliente.nif} • ` : ''}${cliente.ciudad || ''}${cliente.provincia ? ` (${cliente.provincia})` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (clientesCache.length > 50) {
                html += `<div class="autocomplete-count">... y ${clientesCache.length - 50} más (use el buscador)</div>`;
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        }

        function selectCliente(nombreCliente) {
            const cliente = clientesCache.find(c => c.nombre === nombreCliente);
            if (!cliente) {
                console.error('Cliente no encontrado:', nombreCliente);
                return;
            }
            
            console.log('Seleccionando cliente:', cliente);
            
            // Rellenar todos los campos del cliente
            const nombreInput = document.getElementById('cliente-nombre');
            const nifInput = document.getElementById('cliente-nif');
            const emailInput = document.getElementById('cliente-email');
            const direccionInput = document.getElementById('cliente-direccion');
            const cpInput = document.getElementById('cliente-cp');
            const ciudadInput = document.getElementById('cliente-ciudad');
            const provinciaInput = document.getElementById('cliente-provincia');
            
            if (nombreInput) nombreInput.value = cliente.nombre || '';
            if (nifInput) nifInput.value = cliente.nif || '';
            if (emailInput) emailInput.value = cliente.email || '';
            if (direccionInput) direccionInput.value = cliente.direccion || '';
            if (cpInput) cpInput.value = cliente.cp || '';
            if (ciudadInput) ciudadInput.value = cliente.ciudad || '';
            if (provinciaInput) provinciaInput.value = cliente.provincia || '';
            
            console.log('Campos rellenados:', {
                nombre: nombreInput?.value,
                nif: nifInput?.value,
                email: emailInput?.value,
                direccion: direccionInput?.value,
                cp: cpInput?.value,
                ciudad: ciudadInput?.value,
                provincia: provinciaInput?.value
            });
            
            // Ocultar dropdown
            const dropdown = document.getElementById('cliente-autocomplete');
            if (dropdown) dropdown.classList.remove('show');
            
            // Mostrar notificación
            showNotification(`Cliente "${cliente.nombre}" cargado correctamente`, 'success', 3000);
        }

        // Event listener para el campo de cliente-nombre
        document.addEventListener('DOMContentLoaded', () => {
            const clienteNombreInput = document.getElementById('cliente-nombre');
            if (clienteNombreInput) {
                clienteNombreInput.addEventListener('input', (e) => {
                    clearTimeout(autoCompleteDebounceTimer);
                    autoCompleteDebounceTimer = setTimeout(() => {
                        showAutocomplete(e.target.value);
                    }, 300);
                });
                
                // Ocultar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#cliente-nombre') && 
                        !e.target.closest('#cliente-autocomplete') && 
                        !e.target.closest('.btn-cliente-list')) {
                        const dropdown = document.getElementById('cliente-autocomplete');
                        if (dropdown) dropdown.classList.remove('show');
                    }
                });
            }
        });

        function calculateCRC8(data) {
            // Simulación del cálculo CRC8 para TBAI
            const polynomial = 0x07;
            let crc = 0x00;
            const text = data.substring(0, 100);
            for (let i = 0; i < text.length; i++) {
                crc ^= text.charCodeAt(i);
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x80) {
                        crc = (crc << 1) ^ polynomial;
                    } else {
                        crc <<= 1;
                    }
                }
            }
            return (crc & 0xFF).toString(16).toUpperCase().padStart(2, '0');
        }

        function generateTBAIQR(data) {
            const qrContainer = document.getElementById('qrcode-tbai');
            if (qrContainer) {
                qrContainer.innerHTML = '';
                
                const tbaiElement = document.getElementById('tbai-code');
                const tbaiId = tbaiElement ? tbaiElement.textContent : `TBAI-ERROR`;
                
                // Generar CRC de 3 dígitos
                const crc = Math.floor(Math.random() * 900) + 100;
                
                // Construir URL sin codificar, formato directo
                const tbaiURL = `https://ticketbai.araba.eus/tbai/qrtbai/?id=${tbaiId}&s=${data.factura.serie}&nf=${data.factura.numero}&i=${data.totales.total.toFixed(2).replace(',', '.')}&cr=${crc}`;
                
                new QRCode(qrContainer, {
                    text: tbaiURL,
                    width: 100,
                    height: 100,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function printInvoice() {
            const preview = document.getElementById('invoice-preview');
            if (!preview || preview.innerHTML.includes('Vista Previa de Factura') || preview.innerHTML.includes('Complete el formulario')) {
                showNotification('No hay ninguna factura generada para imprimir', 'warning');
                return;
            }
            
            // Imprimir directamente - los estilos @media print se encargan del resto
            window.print();
        }

        function generateTBAIURL(element) {
            // Obtener el código TBAI del elemento
            const tbaiCode = element.querySelector('#tbai-code').textContent;
            
            // Obtener los datos actuales de la factura
            const serie = document.getElementById('factura-serie').value;
            const numero = document.getElementById('factura-numero').value;
            const nif = document.getElementById('emisor-nif').value;
            
            // Calcular el total actual
            let total = 0;
            const items = document.querySelectorAll('#items-container .item-row');
            items.forEach((item) => {
                const id = item.id.split('-')[1];
                const qtyValue = document.getElementById(`qty-${id}`).value;
                const priceValue = document.getElementById(`price-${id}`).value;
                const qty = parseNumberES(qtyValue);
                const price = parseNumberES(priceValue);
                const ivaValue = document.getElementById(`iva-${id}`).value;
                const iva = ivaValue !== '' ? parseFloat(ivaValue) : 21;
                const itemSubtotal = qty * price;
                const itemTotal = itemSubtotal * (1 + iva / 100);
                total += itemTotal;
            });
            
            // Generar CRC de 3 dígitos
            const crc = Math.floor(Math.random() * 900) + 100;
            
            // Construir URL con formato correcto - sin codificar el ID
            const baseUrl = 'https://ticketbai.araba.eus/tbai/qrtbai/';
            const params = `id=${tbaiCode}&s=${serie}&nf=${numero}&i=${total.toFixed(2).replace(',', '.')}&cr=${crc}`;
            
            return `${baseUrl}?${params}`;
        }

        function generateVerificationCode() {
            // Generar código de verificación en formato XXXX-XXXX-XXXX-XXXX
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                if (i > 0) code += '-';
                for (let j = 0; j < 4; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            return code;
        }

        function generateVerificationURL() {
            const verificationCode = document.getElementById('verification-code').textContent;
            return `https://egoitza.araba.eus/izapidetu/sgvfcove/?cove=${verificationCode}`;
        }

        function loadSampleData() {
            // Limpiar formulario primero
            clearForm();
            
            // Arrays de datos aleatorios
            const nombresEmpresa = [
                'Pintxos y Tecnología', 'Txakoli Digital', 'Bacalao Solutions', 'Sidrería Informática',
                'Euskadi Innovations', 'Urdaibai Systems', 'Gorbea Cloud Services', 'Aizkorri Consulting',
                'Caserío Software', 'Traineras Tech', 'Korrika Digital', 'Bertsolari Apps',
                'Sagardotegi IT', 'Gaztelugatxe Networks', 'Txistulari Solutions', 'Pelota Vasca Tech',
                'Idiazabal Coding', 'Gernika Developers', 'Donosti Digital Dreams', 'Bilbo Binary'
            ];
            
            const tiposEmpresa = ['S.L.', 'S.A.', 'S.L.U.', 'S. Coop.', 'S.L.L.'];
            
            const nombres = ['Mikel', 'Ane', 'Jon', 'Miren', 'Iker', 'Leire', 'Unai', 'Amaia', 'Aitor', 'Maite',
                           'Gorka', 'Nekane', 'Xabier', 'Edurne', 'Iñaki', 'Ainhoa', 'Patxi', 'Izaskun'];
            
            const apellidos = ['Etxeberria', 'Aguirre', 'Zabala', 'Mendizabal', 'Urrutia', 'Goikoetxea',
                             'Zubizarreta', 'Aranburu', 'Lekuona', 'Gabilondo', 'Arizmendi', 'Loiola'];
            
            const calles = ['Calle Mayor', 'Paseo de la Concha', 'Alameda Urquijo', 'Gran Vía',
                          'Calle Nagusia', 'Plaza del Castillo', 'Ronda de Atocha', 'Avenida de la Libertad',
                          'Calle San Martín', 'Paseo de Gracia Euskadi', 'Camino de Santiago'];
            
            const ciudadesVascas = [
                { ciudad: 'Bilbao', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Donostia-San Sebastián', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Vitoria-Gasteiz', provincia: 'Araba', cp: '01' },
                { ciudad: 'Getxo', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Irún', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Barakaldo', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Errenteria', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Portugalete', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Santurtzi', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Basauri', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Leioa', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Zarautz', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Hondarribia', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Durango', provincia: 'Bizkaia', cp: '48' },
                { ciudad: 'Eibar', provincia: 'Gipuzkoa', cp: '20' },
                { ciudad: 'Llodio', provincia: 'Araba', cp: '01' }
            ];
            
            const servicios = [
                { desc: 'Consultoría en transformación digital euskaldun', qty: 20, price: 95 },
                { desc: 'Desarrollo de app para sidrerías con QR', qty: 1, price: 4500 },
                { desc: 'Sistema de gestión para sociedades gastronómicas', qty: 1, price: 3200 },
                { desc: 'Digitalización de cartas de pintxos con realidad aumentada', qty: 50, price: 45 },
                { desc: 'Plataforma e-commerce para productos artesanos vascos', qty: 1, price: 5800 },
                { desc: 'App móvil para rutas del Camino de Santiago', qty: 1, price: 3500 },
                { desc: 'Sistema IoT para caseríos inteligentes', qty: 3, price: 1200 },
                { desc: 'Desarrollo web para frontones digitales', qty: 1, price: 2800 },
                { desc: 'Automatización de txoko con domótica', qty: 1, price: 4200 },
                { desc: 'Creación de marketplace para productores de txakoli', qty: 1, price: 6500 },
                { desc: 'Sistema de reservas online para asadores', qty: 1, price: 2400 },
                { desc: 'Digitalización de bertsos con IA', qty: 100, price: 15 },
                { desc: 'App de realidad virtual para museo Guggenheim', qty: 1, price: 8900 },
                { desc: 'Plataforma de streaming para partidos de pelota vasca', qty: 1, price: 7200 },
                { desc: 'Sistema de trazabilidad blockchain para queso Idiazabal', qty: 1, price: 5500 }
            ];
            
            const formaciones = [
                { desc: 'Curso de euskera tecnológico nivel B2', horas: 40, precio: 45 },
                { desc: 'Taller de programación en euskera para txikis', horas: 8, precio: 35 },
                { desc: 'Formación en ciberseguridad para pymes vascas', horas: 16, precio: 85 },
                { desc: 'Workshop de marketing digital para sidrerías', horas: 6, precio: 120 },
                { desc: 'Bootcamp desarrollo web Full Stack Euskadi', horas: 200, precio: 55 }
            ];
            
            // Generar datos aleatorios
            const empresa = nombresEmpresa[Math.floor(Math.random() * nombresEmpresa.length)];
            const tipo = tiposEmpresa[Math.floor(Math.random() * tiposEmpresa.length)];
            const nombre = nombres[Math.floor(Math.random() * nombres.length)];
            const apellido = apellidos[Math.floor(Math.random() * apellidos.length)];
            const ciudadInfo = ciudadesVascas[Math.floor(Math.random() * ciudadesVascas.length)];
            const calle = calles[Math.floor(Math.random() * calles.length)];
            const numero = Math.floor(Math.random() * 150) + 1;
            const piso = Math.floor(Math.random() * 8) + 1;
            const letra = ['A', 'B', 'C', 'D', 'Izq', 'Dcha', 'Centro'][Math.floor(Math.random() * 7)];
            
            // Generar NIF aleatorio
            const numNIF = Math.floor(Math.random() * 90000000) + 10000000;
            const letraNIF = 'ABCDEFGHIJKLMNPQRSUVW'[Math.floor(Math.random() * 21)];
            
            // Completar datos del cliente
            document.getElementById('cliente-nombre').value = `${empresa} ${tipo}`;
            document.getElementById('cliente-nif').value = `${letraNIF}${numNIF}`;
            document.getElementById('cliente-email').value = `${nombre.toLowerCase()}@${empresa.toLowerCase().replace(/[^a-z0-9]/g, '')}.eus`;
            document.getElementById('cliente-direccion').value = `${calle}, ${numero}, ${piso}º ${letra}`;
            document.getElementById('cliente-cp').value = ciudadInfo.cp + String(Math.floor(Math.random() * 900) + 100);
            document.getElementById('cliente-ciudad').value = ciudadInfo.ciudad;
            document.getElementById('cliente-provincia').value = ciudadInfo.provincia;
            
            // Datos de la factura
            document.getElementById('factura-numero').value = Math.floor(Math.random() * 900) + 100;
            
            // Generar descripción aleatoria
            const descripciones = [
                `Servicios de consultoría tecnológica para la digitalización completa de ${empresa} ${tipo}, incluyendo análisis de procesos, implementación de soluciones cloud y formación del personal.`,
                `Desarrollo e implementación de sistema integral de gestión empresarial adaptado a las necesidades específicas del sector de ${empresa} ${tipo}.`,
                `Proyecto de transformación digital 4.0 para optimizar los procesos productivos y administrativos de ${empresa} ${tipo}, con especial énfasis en la sostenibilidad.`,
                `Servicios profesionales de desarrollo, mantenimiento y soporte técnico continuado para la infraestructura tecnológica de ${empresa} ${tipo}.`,
                `Consultoría estratégica y desarrollo de soluciones innovadoras para mejorar la competitividad digital de ${empresa} ${tipo} en el mercado vasco y nacional.`
            ];
            
            document.getElementById('operacion-descripcion').value = descripciones[Math.floor(Math.random() * descripciones.length)];
            
            // Añadir entre 2 y 5 conceptos aleatorios
            const numConceptos = Math.floor(Math.random() * 4) + 2;
            const serviciosUsados = [];
            
            for (let i = 1; i <= numConceptos; i++) {
                addItem();
                
                if (Math.random() > 0.3) {
                    // 70% servicios
                    const servicio = servicios[Math.floor(Math.random() * servicios.length)];
                    document.getElementById(`desc-${i}`).value = servicio.desc;
                    document.getElementById(`qty-${i}`).value = servicio.qty;
                    document.getElementById(`price-${i}`).value = formatNumber(servicio.price);
                } else {
                    // 30% formaciones
                    const formacion = formaciones[Math.floor(Math.random() * formaciones.length)];
                    document.getElementById(`desc-${i}`).value = formacion.desc;
                    document.getElementById(`qty-${i}`).value = formacion.horas;
                    document.getElementById(`price-${i}`).value = formatNumber(formacion.precio);
                }
                
                // Formateo qty y price SIEMPRE
                document.getElementById(`qty-${i}`).value = formatNumber(parseNumberES(document.getElementById(`qty-${i}`).value));
                document.getElementById(`price-${i}`).value = formatNumber(parseNumberES(document.getElementById(`price-${i}`).value));
                
                // IVA aleatorio (la mayoría 21%, algunos 10% o 4%)
                const ivaRandom = Math.random();
                if (ivaRandom > 0.9) {
                    document.getElementById(`iva-${i}`).value = '4';
                } else if (ivaRandom > 0.8) {
                    document.getElementById(`iva-${i}`).value = '10';
                } else {
                    document.getElementById(`iva-${i}`).value = '21';
                }
                
                calculateItemTotal(i);
            }
            
        }

        // Sistema de gestión de facturas con Google Sheets
        
        // Función auxiliar para procesar fecha (con o sin hora)
        function processFechaHora(fechaString) {
            if (!fechaString) return { objeto: new Date(), solo_fecha: '', con_hora: '' };
            
            let fechaObj;
            let tieneHora = false;
            const fechaStr = fechaString.toString().trim();
            
            // Detectar formato español: dd/mm/yyyy H:MM o dd/mm/yyyy HH:MM o dd/mm/yy H:MM
            if (fechaStr.includes('/') && fechaStr.includes(' ') && fechaStr.includes(':')) {
                // Formato español con hora: "16/06/2025 8:31" o "16/06/25 8:31"
                const [fechaParte, horaParte] = fechaStr.split(' ');
                const [dia, mes, ano] = fechaParte.split('/');
                const [horas, minutos] = horaParte.split(':');
                let anoCompleto = ano;
                // Si el año tiene 2 dígitos, convertir a 4
                if (ano.length === 2) {
                    const anoNum = parseInt(ano);
                    anoCompleto = anoNum >= 0 && anoNum <= 50 ? '20' + ano : '19' + ano;
                }
                fechaObj = new Date(parseInt(anoCompleto), parseInt(mes) - 1, parseInt(dia), parseInt(horas), parseInt(minutos));
                tieneHora = true;
            } 
            // Formato dd/mm/yyyy o dd/mm/yy
            else if (fechaStr.includes('/')) {
                const [dia, mes, ano] = fechaStr.split('/');
                let anoCompleto = ano;
                // Si el año tiene 2 dígitos, convertir a 4
                if (ano.length === 2) {
                    const anoNum = parseInt(ano);
                    anoCompleto = anoNum >= 0 && anoNum <= 50 ? '20' + ano : '19' + ano;
                }
                fechaObj = new Date(parseInt(anoCompleto), parseInt(mes) - 1, parseInt(dia), 0, 0);
            }
            // Formato dd-mm-yyyy o dd-mm-yy
            else if (fechaStr.includes('-') && fechaStr.indexOf('-') === 2) {
                const [dia, mes, ano] = fechaStr.split('-');
                let anoCompleto = ano;
                // Si el año tiene 2 dígitos, convertir a 4
                if (ano.length === 2) {
                    const anoNum = parseInt(ano);
                    anoCompleto = anoNum >= 0 && anoNum <= 50 ? '20' + ano : '19' + ano;
                }
                fechaObj = new Date(parseInt(anoCompleto), parseInt(mes) - 1, parseInt(dia), 0, 0);
            }
            // Formato DDMMAAAA (8 dígitos sin separadores)
            else if (fechaStr.length === 8 && /^\d{8}$/.test(fechaStr)) {
                const dia = parseInt(fechaStr.substring(0, 2));
                const mes = parseInt(fechaStr.substring(2, 4));
                const ano = parseInt(fechaStr.substring(4, 8));
                fechaObj = new Date(ano, mes - 1, dia, 0, 0);
            }
            // Formato DDMMAA (6 dígitos sin separadores)
            else if (fechaStr.length === 6 && /^\d{6}$/.test(fechaStr)) {
                const dia = parseInt(fechaStr.substring(0, 2));
                const mes = parseInt(fechaStr.substring(2, 4));
                const ano = parseInt(fechaStr.substring(4, 6));
                const anoCompleto = ano >= 0 && ano <= 50 ? 2000 + ano : 1900 + ano;
                fechaObj = new Date(anoCompleto, mes - 1, dia, 0, 0);
            }
            // Formato ISO: "2025-06-16T08:31"
            else if (fechaStr.includes('T')) {
                fechaObj = new Date(fechaStr);
                tieneHora = fechaStr.includes(':');
            }
            // Formato ISO solo fecha: "2025-06-16" o "yyyy-mm-dd"
            else if (fechaStr.includes('-') && fechaStr.indexOf('-') === 4) {
                fechaObj = new Date(fechaStr + 'T00:00:00');
            }
            // Intentar parsear como Date estándar
            else {
                fechaObj = new Date(fechaStr);
            }
            
            // Validar que la fecha es válida
            if (isNaN(fechaObj.getTime())) {
                console.warn('Fecha inválida:', fechaStr);
                fechaObj = new Date();
            }
            
            const day = String(fechaObj.getDate()).padStart(2, '0');
            const month = String(fechaObj.getMonth() + 1).padStart(2, '0');
            const year = fechaObj.getFullYear();
            const hours = fechaObj.getHours();
            const minutes = String(fechaObj.getMinutes()).padStart(2, '0');
            
            return {
                objeto: fechaObj,
                solo_fecha: `${day}/${month}/${year}`,
                con_hora: tieneHora ? `${day}/${month}/${year} ${hours}:${minutes}` : `${day}/${month}/${year}`
            };
        }
        
        // Función para abrir Google Sheets en nueva pestaña
        function openGoogleSheets() {
            window.open('https://docs.google.com/spreadsheets/d/1qCDvaMEERQ3lm1MLWQnl2TblwtxA-17hoFo8leG70kg/edit?gid=0#gid=0', '_blank');
        }
        
        // Guardar automáticamente (proceso invisible)
        // ========== CONVERSIÓN HTML ↔ MARKDOWN ==========
        
        // Convertir HTML del editor a Markdown para guardar
        function htmlToMarkdown(html) {
            if (!html) return '';
            
            let markdown = html;
            
            // Tamaños de fuente (del más grande al más pequeño para evitar conflictos)
            // Font size 7 y 6 → ## (muy grande)
            markdown = markdown.replace(/<font[^>]*size=["']?[67]["']?[^>]*>(.*?)<\/font>/gi, '## $1');
            // Font size 5 y 4 → # (grande)
            markdown = markdown.replace(/<font[^>]*size=["']?[45]["']?[^>]*>(.*?)<\/font>/gi, '# $1');
            // Font size 2 y 1 → ~ (pequeño)
            markdown = markdown.replace(/<font[^>]*size=["']?1["']?[^>]*>(.*?)<\/font>/gi, '$1~~');
            markdown = markdown.replace(/<font[^>]*size=["']?2["']?[^>]*>(.*?)<\/font>/gi, '$1~');
            
            // Negrita
            markdown = markdown.replace(/<(strong|b)>(.*?)<\/(strong|b)>/gi, '**$2**');
            
            // Cursiva
            markdown = markdown.replace(/<(em|i)>(.*?)<\/(em|i)>/gi, '*$2*');
            
            // Subrayado
            markdown = markdown.replace(/<u>(.*?)<\/u>/gi, '__$1__');
            
            // Listas
            markdown = markdown.replace(/<ul[^>]*>/gi, '');
            markdown = markdown.replace(/<\/ul>/gi, '');
            markdown = markdown.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
            
            // Saltos de línea
            markdown = markdown.replace(/<br\s*\/?>/gi, '\n');
            markdown = markdown.replace(/<\/div>/gi, '\n');
            markdown = markdown.replace(/<div[^>]*>/gi, '');
            
            // Limpiar otros tags HTML restantes
            markdown = markdown.replace(/<[^>]+>/g, '');
            
            // Decodificar entidades HTML
            const temp = document.createElement('div');
            temp.innerHTML = markdown;
            markdown = temp.textContent || temp.innerText || markdown;
            
            // Limpiar líneas vacías múltiples
            markdown = markdown.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            return markdown.trim();
        }
        
        // Convertir Markdown a HTML para mostrar en el editor
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // Escapar HTML existente
            html = html.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
            
            // Tamaños de fuente (procesar antes que negrita/cursiva)
            // ## texto → muy grande
            html = html.replace(/^## (.+)$/gm, '<font size="6">$1</font>');
            html = html.replace(/## (.+?)(?=\n|$)/g, '<font size="6">$1</font>');
            
            // # texto → grande
            html = html.replace(/^# (.+)$/gm, '<font size="5">$1</font>');
            html = html.replace(/# (.+?)(?=\n|$)/g, '<font size="5">$1</font>');
            
            // texto~~ → muy pequeño
            html = html.replace(/(.+?)~~/g, '<font size="1">$1</font>');
            
            // texto~ → pequeño
            html = html.replace(/(.+?)~/g, '<font size="2">$1</font>');
            
            // **texto** → negrita
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // *texto* → cursiva (pero no ** ya procesado)
            html = html.replace(/(?<!\*)\*([^\*]+?)\*(?!\*)/g, '<em>$1</em>');
            
            // __texto__ → subrayado
            html = html.replace(/__(.+?)__/g, '<u>$1</u>');
            
            // - item → lista
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Saltos de línea
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        async function saveInvoiceAutomatically(invoiceData) {
            // Preparar datos para insertar
            const itemsDescription = invoiceData.items.map(item => 
                `${item.descripcion} (${formatNumber(item.cantidad)}x${formatNumber(item.precio)}€)`
            ).join('; ');
            
            const fechaData = processFechaHora(invoiceData.factura.fecha);
            
            // Convertir texto libre de HTML a Markdown
            const textoLibreMarkdown = htmlToMarkdown(invoiceData.factura.textoLibre);
            
            // Datos a enviar con el nuevo formato
            const payload = {
                fecha: fechaData.solo_fecha,
                serie: invoiceData.factura.serie,
                numero: invoiceData.factura.numero,
                nif: invoiceData.cliente.nif,
                cliente: invoiceData.cliente.nombre,
                direccion: invoiceData.cliente.direccion,
                cp: invoiceData.cliente.cp,
                ciudad: invoiceData.cliente.ciudad,
                provincia: invoiceData.cliente.provincia,
                email: invoiceData.cliente.email,
                descripcion: invoiceData.factura.descripcionOperacion,
                textoLibre: textoLibreMarkdown,
                base: formatNumberForSheet(invoiceData.totales.subtotal),
                iva: formatNumberForSheet(invoiceData.totales.iva),
                total: formatNumberForSheet(invoiceData.totales.total),
                items: itemsDescription,
                // Enviar también el detalle de cada línea
                itemsDetail: invoiceData.items.map(item => ({
                    descripcion: item.descripcion,
                    cantidad: formatNumberForSheet(item.cantidad),
                    precio: formatNumberForSheet(item.precio),
                    subtotal: formatNumberForSheet(item.subtotal),
                    iva: formatNumberForSheet(item.subtotal * item.iva / 100),
                    total: formatNumberForSheet(item.total)
                }))
            };
            
            // ✅ LÓGICA EN HTML: Verificar si la factura ya existe Y si hay modificaciones
            try {
                // Cargar todas las facturas para verificar si existe
                const response = await fetch(WEB_APP_URL);
                const allData = await response.json();
                
                // Buscar filas con el mismo NÚMERO de factura (columna 2)
                const existingRows = [];
                let hasChanges = false;
                
                if (allData && Array.isArray(allData)) {
                    allData.forEach((row, index) => {
                        if (index > 0 && row[2] === payload.numero) {
                            existingRows.push({
                                rowIndex: index + 1,
                                data: row
                            });
                        }
                    });
                }
                
                // Si existe, comparar datos para detectar cambios
                if (existingRows.length > 0) {
                    console.log('📋 Factura existente encontrada (Nº ' + payload.numero + '). Verificando si hay cambios...');
                    
                    const existingFirstRow = existingRows[0].data;
                    
                    // Comparar campos principales (columnas: 0=Fecha, 1=Serie, 3=NIF, 4=Cliente, etc.)
                    if (existingFirstRow[0] !== payload.fecha ||
                        existingFirstRow[1] !== payload.serie ||
                        existingFirstRow[3] !== payload.nif ||
                        existingFirstRow[4] !== payload.cliente ||
                        existingFirstRow[5] !== payload.direccion ||
                        existingFirstRow[6] !== payload.cp ||
                        existingFirstRow[7] !== payload.ciudad ||
                        existingFirstRow[8] !== payload.provincia ||
                        existingFirstRow[9] !== payload.email ||
                        existingFirstRow[10] !== payload.descripcion ||
                        existingFirstRow[11] !== payload.textoLibre ||
                        existingRows.length !== payload.itemsDetail.length) {
                        hasChanges = true;
                    } else {
                        // Comparar items detallados
                        for (let i = 0; i < existingRows.length; i++) {
                            const existingRow = existingRows[i].data;
                            const newItem = payload.itemsDetail[i];
                            
                            if (existingRow[12] !== newItem.descripcion ||
                                existingRow[13] !== newItem.cantidad ||
                                existingRow[14] !== newItem.precio ||
                                existingRow[15] !== newItem.subtotal ||
                                existingRow[16] !== newItem.iva ||
                                existingRow[17] !== newItem.total) {
                                hasChanges = true;
                                break;
                            }
                        }
                    }
                    
                    // Solo enviar deleteRows si hay cambios
                    if (hasChanges) {
                        payload.deleteRows = existingRows.map(r => r.rowIndex);
                        payload.isUpdate = true; // Marcar como actualización
                        console.log('🔄 Cambios detectados. Se actualizarán ' + existingRows.length + ' filas.');
                    } else {
                        console.log('✅ No hay cambios. No se actualizará nada.');
                        showNotification('✅ La factura ya existe sin cambios', 'info');
                        return; // No continuar con el guardado
                    }
                } else {
                    payload.isUpdate = false; // Marcar como nueva
                }
            } catch (error) {
                console.log('⚠️ No se pudo verificar facturas existentes, se guardará como nueva:', error);
                payload.isUpdate = false;
            }
            
            // Enviar al Web App
            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.result === 'success') {
                    // Factura guardada correctamente
                    // Notificación según si es nueva o actualización
                    const mensaje = payload.isUpdate ? 
                        '✅ Factura MODIFICADA correctamente en Google Sheets' : 
                        '✅ Factura NUEVA guardada correctamente en Google Sheets';
                    showNotification(mensaje, 'success');
                } else {
                    throw new Error(data.error || 'Error al guardar');
                }
            })
            .catch(error => {
                console.error('Error al guardar automáticamente:', error);
                // Si hay error, no mostrar nada al usuario para que sea invisible
                // Solo registrar en consola para debugging
            });
        }
        
        // Guardar manualmente cuando el usuario lo solicite
        async function saveToGoogleSheetsWebApp() {
            if (!validateForm()) {
                showNotification('Por favor, complete todos los campos obligatorios antes de guardar', 'error');
                return;
            }
            
            const invoiceData = collectInvoiceData();
            showNotification('💾 Guardando factura...', 'info');
            
            // Preparar datos para insertar
            const itemsDescription = invoiceData.items.map(item => 
                `${item.descripcion} (${formatNumber(item.cantidad)}x${formatNumber(item.precio)}€)`
            ).join('; ');
            
            const fechaData = processFechaHora(invoiceData.factura.fecha);
            
            // Convertir texto libre de HTML a Markdown
            const textoLibreMarkdown = htmlToMarkdown(invoiceData.factura.textoLibre);
            
            // Datos a enviar con el mismo formato que saveInvoiceAutomatically
            const payload = {
                fecha: fechaData.solo_fecha,
                serie: invoiceData.factura.serie,
                numero: invoiceData.factura.numero,
                nif: invoiceData.cliente.nif,
                cliente: invoiceData.cliente.nombre,
                direccion: invoiceData.cliente.direccion,
                cp: invoiceData.cliente.cp,
                ciudad: invoiceData.cliente.ciudad,
                provincia: invoiceData.cliente.provincia,
                email: invoiceData.cliente.email,
                descripcion: invoiceData.factura.descripcionOperacion,
                textoLibre: textoLibreMarkdown,
                base: formatNumberForSheet(invoiceData.totales.subtotal),
                iva: formatNumberForSheet(invoiceData.totales.iva),
                total: formatNumberForSheet(invoiceData.totales.total),
                items: itemsDescription,
                // Enviar también el detalle de cada línea
                itemsDetail: invoiceData.items.map(item => ({
                    descripcion: item.descripcion,
                    cantidad: formatNumberForSheet(item.cantidad),
                    precio: formatNumberForSheet(item.precio),
                    subtotal: formatNumberForSheet(item.subtotal),
                    iva: formatNumberForSheet(item.subtotal * item.iva / 100),
                    total: formatNumberForSheet(item.total)
                }))
            };
            
            // ✅ LÓGICA EN HTML: Verificar si la factura ya existe Y si hay modificaciones
            try {
                // Cargar todas las facturas para verificar si existe
                const response = await fetch(WEB_APP_URL);
                const allData = await response.json();
                
                // Buscar filas con el mismo NÚMERO de factura (columna 2)
                const existingRows = [];
                let hasChanges = false;
                
                if (allData && Array.isArray(allData)) {
                    allData.forEach((row, index) => {
                        if (index > 0 && row[2] === payload.numero) {
                            existingRows.push({
                                rowIndex: index + 1,
                                data: row
                            });
                        }
                    });
                }
                
                // Si existe, comparar datos para detectar cambios
                if (existingRows.length > 0) {
                    console.log('📋 Factura existente encontrada (Nº ' + payload.numero + '). Verificando si hay cambios...');
                    
                    const existingFirstRow = existingRows[0].data;
                    
                    // Comparar campos principales (columnas: 0=Fecha, 1=Serie, 3=NIF, 4=Cliente, etc.)
                    if (existingFirstRow[0] !== payload.fecha ||
                        existingFirstRow[1] !== payload.serie ||
                        existingFirstRow[3] !== payload.nif ||
                        existingFirstRow[4] !== payload.cliente ||
                        existingFirstRow[5] !== payload.direccion ||
                        existingFirstRow[6] !== payload.cp ||
                        existingFirstRow[7] !== payload.ciudad ||
                        existingFirstRow[8] !== payload.provincia ||
                        existingFirstRow[9] !== payload.email ||
                        existingFirstRow[10] !== payload.descripcion ||
                        existingFirstRow[11] !== payload.textoLibre ||
                        existingRows.length !== payload.itemsDetail.length) {
                        hasChanges = true;
                    } else {
                        // Comparar items detallados
                        for (let i = 0; i < existingRows.length; i++) {
                            const existingRow = existingRows[i].data;
                            const newItem = payload.itemsDetail[i];
                            
                            if (existingRow[12] !== newItem.descripcion ||
                                existingRow[13] !== newItem.cantidad ||
                                existingRow[14] !== newItem.precio ||
                                existingRow[15] !== newItem.subtotal ||
                                existingRow[16] !== newItem.iva ||
                                existingRow[17] !== newItem.total) {
                                hasChanges = true;
                                break;
                            }
                        }
                    }
                    
                    // Solo enviar deleteRows si hay cambios
                    if (hasChanges) {
                        payload.deleteRows = existingRows.map(r => r.rowIndex);
                        payload.isUpdate = true; // Marcar como actualización
                        console.log('🔄 Cambios detectados. Se actualizarán ' + existingRows.length + ' filas.');
                    } else {
                        console.log('✅ No hay cambios. No se actualizará nada.');
                        showNotification('✅ La factura ya existe sin cambios', 'info');
                        return; // No continuar con el guardado
                    }
                } else {
                    payload.isUpdate = false; // Marcar como nueva
                }
            } catch (error) {
                console.log('⚠️ No se pudo verificar facturas existentes, se guardará como nueva:', error);
                payload.isUpdate = false;
            }
            
            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    const mensaje = payload.isUpdate ? 
                        '✅ Factura MODIFICADA correctamente en Google Sheets' : 
                        '✅ Factura NUEVA guardada correctamente en Google Sheets';
                    showNotification(mensaje, 'success');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error al guardar la factura', 'error');
                // Si el Web App no funciona, mostrar instrucciones para el método manual
                showManualInstructions(invoiceData);
            });
        }
        
        // Mostrar instrucciones para guardar manualmente
        function showManualInstructions(invoiceData) {
            const itemsDescription = invoiceData.items.map(item => 
                `${item.descripcion} (${formatNumber(item.cantidad)}x${formatNumber(item.precio)}€)`
            ).join('; ');
            
            const fechaData = processFechaHora(invoiceData.factura.fecha);
            
            const datosParaCopiar = [
                fechaData.solo_fecha,
                invoiceData.factura.serie,
                invoiceData.factura.numero,
                invoiceData.cliente.nombre,
                invoiceData.cliente.nif,
                invoiceData.cliente.email,
                invoiceData.cliente.direccion,
                invoiceData.cliente.ciudad,
                invoiceData.cliente.cp,
                formatNumber(invoiceData.totales.subtotal),
                formatNumber(invoiceData.totales.iva),
                formatNumber(invoiceData.totales.total),
                invoiceData.factura.descripcionOperacion,
                itemsDescription
            ].join('\t');
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(datosParaCopiar).then(() => {
                showNotification('Los datos de la factura se han copiado al portapapeles.\n\n' +
                      'Para guardarla manualmente:\n' +
                      '1. Abra el Google Sheets (botón "Abrir Google Sheets")\n' +
                      '2. Vaya a la última fila vacía\n' +
                      '3. Haga clic en la celda A de esa fila\n' +
                      '4. Pegue con Ctrl+V (o Cmd+V en Mac)\n\n' +
                      'Los datos ya están en su portapapeles.', 'info', 10000);
            }).catch(() => {
                showNotification('No se pudo copiar automáticamente.\n\nCopie manualmente estos datos:\n\n' + datosParaCopiar, 'warning', 15000);
            });
        }
        
        // Guardar en Google Sheets público (sin autenticación)
        function saveToGoogleSheetsPublic() {
            if (!validateForm()) {
                showNotification('Por favor, complete todos los campos obligatorios antes de guardar', 'error');
                return;
            }
            
            const invoiceData = collectInvoiceData();
            showNotification('💾 Intentando guardar en Google Sheets público...', 'info');
            
            // Preparar datos para insertar
            const itemsDescription = invoiceData.items.map(item => 
                `${item.descripcion} (${formatNumber(item.cantidad)}x${formatNumber(item.precio)}€)`
            ).join('; ');
            
            const fechaData = processFechaHora(invoiceData.factura.fecha);
            
            const values = [[
                fechaData.solo_fecha,
                invoiceData.factura.serie,
                invoiceData.factura.numero,
                invoiceData.cliente.nombre,
                invoiceData.cliente.nif,
                invoiceData.cliente.email,
                invoiceData.cliente.direccion,
                invoiceData.cliente.ciudad,
                invoiceData.cliente.cp,
                formatNumber(invoiceData.totales.subtotal),
                formatNumber(invoiceData.totales.iva),
                formatNumber(invoiceData.totales.total),
                invoiceData.factura.descripcionOperacion,
                itemsDescription
            ]];
            
            // Usar fetch con la API de Google Sheets
            const range = 'A:N';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS&key=${API_KEY}`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    values: values
                })
            })
            .then(response => {
                return response.text().then(text => {
                    if (!response.ok) {
                        let errorMsg = `Error ${response.status}`;
                        try {
                            const errorData = JSON.parse(text);
                            if (errorData.error && errorData.error.message) {
                                errorMsg = errorData.error.message;
                            }
                        } catch (e) {
                            // No es JSON
                        }
                        throw new Error(errorMsg);
                    }
                    return JSON.parse(text);
                });
            })
            .then(data => {
                showNotification('✅ Factura guardada', 'success');
            })
            .catch(error => {
                console.error('Error detallado:', error);
                showNotification(`❌ Error al guardar: ${error.message}`, 'error');
                
                if (error.message.includes('PERMISSION_DENIED') || error.message.includes('403')) {
                    showNotification('El Google Sheets no tiene los permisos correctos.\n\nPor favor:\n1. Abra el Google Sheets\n2. Haga clic en "Compartir"\n3. En "Acceso general" seleccione "Cualquier persona con el enlace"\n4. Asegúrese de que tenga permisos de "Editor"\n5. Haga clic en "Listo"', 'error', 12000);
                } else if (error.message.includes('API key not valid')) {
                    showNotification('Problema con la API Key. Por favor, use la opción de autenticación con Google.', 'error');
                }
            });
        }
        
        function collectInvoiceData() {
            const invoiceData = {
                emisor: {
                    nombre: document.getElementById('emisor-nombre').value,
                    nif: document.getElementById('emisor-nif').value,
                    telefono: document.getElementById('emisor-telefono').value,
                    direccion: document.getElementById('emisor-direccion').value,
                    cp: document.getElementById('emisor-cp').value,
                    ciudad: document.getElementById('emisor-ciudad').value,
                    provincia: document.getElementById('emisor-provincia').value
                },
                cliente: {
                    nombre: document.getElementById('cliente-nombre').value,
                    nif: document.getElementById('cliente-nif').value,
                    email: document.getElementById('cliente-email').value,
                    direccion: document.getElementById('cliente-direccion').value,
                    cp: document.getElementById('cliente-cp').value,
                    ciudad: document.getElementById('cliente-ciudad').value,
                    provincia: document.getElementById('cliente-provincia').value
                },
                factura: {
                    serie: document.getElementById('factura-serie').value,
                    numero: document.getElementById('factura-numero').value,
                    fecha: document.getElementById('factura-fecha').value,
                    descripcionOperacion: document.getElementById('operacion-descripcion').value,
                    textoLibre: document.getElementById('texto-libre').innerHTML || ''
                },
                items: []
            };
            
            // Recopilar items
            const items = document.querySelectorAll('#items-container .item-row');
            let subtotal = 0;
            let totalIVA = 0;
            
            items.forEach((item) => {
                const id = item.id.split('-')[1];
                const desc = document.getElementById(`desc-${id}`).value;
                const qtyValue = document.getElementById(`qty-${id}`).value;
                const priceValue = document.getElementById(`price-${id}`).value;
                const qty = qtyValue ? parseNumberES(qtyValue) : 0;
                const price = priceValue ? parseNumberES(priceValue) : 0;
                const ivaValue = document.getElementById(`iva-${id}`).value;
                const iva = ivaValue !== '' ? parseFloat(ivaValue) : 21;
                
                if (desc) {
                    const itemSubtotal = qty * price;
                    const itemIVA = itemSubtotal * (iva / 100);
                    subtotal += itemSubtotal;
                    totalIVA += itemIVA;
                    
                    invoiceData.items.push({
                        descripcion: desc,
                        cantidad: qty,
                        precio: price,
                        iva: iva,
                        subtotal: itemSubtotal,
                        total: itemSubtotal + itemIVA
                    });
                }
            });
            
            invoiceData.totales = {
                subtotal: subtotal,
                iva: totalIVA,
                total: subtotal + totalIVA
            };
            
            return invoiceData;
        }
        
        // Variables para el grid
        let invoicesData = [];
        let filteredData = [];
        let originalDataOrder = []; // Guardar el orden original
        let selectedRows = new Set();
        let selectedRow = null;
        let headers = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let sortStates = {}; // Estado de ordenamiento por columna (asc, desc, original)
        let multiSortColumns = []; // Array de columnas para ordenamiento múltiple [{column: 'nombre', direction: 'asc'}, ...]
        let columnFilters = {};
        let customColumnWidths = {}; // Guardar anchos personalizados
        let hiddenColumns = new Set(); // Columnas ocultas
        let groupByColumn = null; // Columna por la que se está agrupando
        let groupedData = {}; // Datos agrupados
        let expandedGroups = new Set(); // Grupos expandidos
        let selectedSumColumns = new Set(); // Columnas numéricas seleccionadas para sumar
        let columnOperations = {}; // Operaciones seleccionadas para cada columna

        // Abrir grid en nueva pestaña
        function openGridInNewTab() {
            const currentUrl = window.location.href.split('?')[0];
            window.open(currentUrl + '?view=grid', '_blank');
        }

        // Alternar vista del grid
        function toggleGridView() {
            const mainContainer = document.querySelector('.container');
            const gridSection = document.getElementById('grid-section');
            const btnGestion = document.getElementById('btn-gestion-facturas');
            
            if (gridSection.style.display === 'none') {
                // Mostrar grid
                mainContainer.style.display = 'none';
                gridSection.style.display = 'block';
                loadInvoices();
                
                // Cambiar texto del botón a "Facturar"
                btnGestion.innerHTML = '📝 Facturar ▼';
                
                // Actualizar estado del dropdown
                updateDropdownState('grid');
            } else {
                // Volver al formulario
                gridSection.style.display = 'none';
                mainContainer.style.display = 'block';
                
                // Restaurar texto del botón
                btnGestion.innerHTML = '📊 Gestión de Facturas ▼';
                
                // Actualizar estado del dropdown
                updateDropdownState('form');
            }
        }
        
        function updateDropdownState(view) {
            const btnGestion = document.getElementById('btn-gestion-facturas');
            const btnGenerar = document.querySelector('.btn-header.primary');
            const toolsDropdown = document.querySelector('.dropdown:nth-of-type(3) .dropdown-content');
            
            if (view === 'grid') {
                // Cambiar texto del botón Gestión y deshabilitarlo
                if (btnGestion) {
                    btnGestion.innerHTML = '📝 Facturar ▼';
                    btnGestion.style.opacity = '0.5';
                    btnGestion.style.pointerEvents = 'none';
                    
                    // Deshabilitar el dropdown de Gestión de Facturas
                    const gestionDropdown = btnGestion.parentElement;
                    if (gestionDropdown) {
                        gestionDropdown.style.pointerEvents = 'none';
                    }
                }
                
                // Deshabilitar botón Generar Factura
                if (btnGenerar) {
                    btnGenerar.style.opacity = '0.5';
                    btnGenerar.style.pointerEvents = 'none';
                }
                
                // Cambiar texto en menú de herramientas
                if (toolsDropdown) {
                    const listadoLink = toolsDropdown.querySelector('a[onclick*="toggleGridView()"]');
                    if (listadoLink) {
                        listadoLink.innerHTML = '📋 Ir a facturas';
                    }
                }
            } else {
                // Restaurar estado normal
                if (btnGestion) {
                    btnGestion.innerHTML = '📊 Gestión de Facturas ▼';
                    btnGestion.style.opacity = '1';
                    btnGestion.style.pointerEvents = 'auto';
                    
                    // Restaurar el dropdown de Gestión de Facturas
                    const gestionDropdown = btnGestion.parentElement;
                    if (gestionDropdown) {
                        gestionDropdown.style.pointerEvents = 'auto';
                    }
                }
                
                // Restaurar botón Generar Factura
                if (btnGenerar) {
                    btnGenerar.style.opacity = '1';
                    btnGenerar.style.pointerEvents = 'auto';
                }
                
                // Restaurar texto en menú de herramientas
                if (toolsDropdown) {
                    const volverLink = toolsDropdown.querySelector('a[onclick*="toggleGridView()"]');
                    if (volverLink) {
                        volverLink.innerHTML = '📋 Ir al listado de facturas';
                    }
                }
            }
        }

        // Cargar facturas desde Google Sheets
        function loadInvoices() {
            const startTime = performance.now();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('invoicesGrid').style.display = 'none';
            
            fetch(WEB_APP_URL + '?action=read')
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        invoicesData = data.data;
                        filteredData = [...invoicesData];
                        originalDataOrder = [...invoicesData]; // Guardar orden original
                        headers = data.headers;
                        
                        // Resetear TODO: selección, ordenamiento, filtros
                        selectedRows.clear();
                        selectedRow = null;
                        
                        // Resetear ordenamiento
                        sortStates = {};
                        multiSortColumns = [];
                        sortColumn = null;
                        sortDirection = 'asc';
                        
                        // Resetear filtros
                        columnFilters = {};
                        document.getElementById('searchInput').value = '';
                        
                        // Aplicar ordenación inicial por Serie y luego por Fecha
                        multiSortColumns = [
                            { column: 'Serie', direction: 'asc' },
                            { column: 'Fecha', direction: 'asc' }
                        ];
                        sortStates['Serie'] = 'asc';
                        sortStates['Fecha'] = 'asc';
                        applyMultiSort();
                        
                        // Renderizar grid y calcular estadísticas
                        renderGrid();
                        updateStatus();
                        updateSaveSortButton();
                        
                        // Cargar clientes para autocompletado
                        loadClientesForAutocomplete();
                        
                        // Mostrar tiempo de carga
                        const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
                        document.getElementById('loadTime').textContent = `Cargado en ${loadTime}s`;
                        
                        // Mostrar grid
                        document.getElementById('invoicesGrid').style.display = 'table';
                        
                        // Forzar actualización de estadísticas
                        setTimeout(() => {
                            calculateStats();
                            const statsBar = document.getElementById('statsBar');
                            if (statsBar) {
                                statsBar.style.display = 'flex';
                                statsBar.style.opacity = '1';
                            }
                            
                            // Autoajustar todas las columnas después de cargar
                            setTimeout(() => {
                                autofitAllColumns();
                            }, 200);
                        }, 100);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                });
        }

        // Renderizar el grid
        function renderGrid() {
            const headerRow = document.getElementById('gridHeader');
            const body = document.getElementById('gridBody');
            
            // Limpiar contenido
            headerRow.innerHTML = '';
            body.innerHTML = '';
            
            // Crear encabezados
            const tr = document.createElement('tr');
            
            // Checkbox para seleccionar todo
            const checkboxTh = document.createElement('th');
            checkboxTh.className = 'checkbox-cell';
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = 'selectAllCheckbox';
            selectAllCheckbox.onchange = toggleSelectAll;
            checkboxTh.appendChild(selectAllCheckbox);
            tr.appendChild(checkboxTh);
            
            // Encabezados de datos (filtrar columnas ocultas)
            headers.filter(header => !hiddenColumns.has(header)).forEach((header, index) => {
                const th = document.createElement('th');
                th.className = 'sortable';
                th.style.position = 'relative';
                
                // Usar ancho personalizado si existe, sino usar ancho por defecto
                let columnWidth = customColumnWidths[header];
                
                if (!columnWidth) {
                    // Establecer anchos iniciales según el tipo de columna
                    if (header === 'Cliente' || header === 'Dirección') {
                        columnWidth = '200px';
                    } else if (header === 'Descripción' || header === 'Detalle') {
                        columnWidth = '250px';
                    } else if (header === 'Base Imponible' || header === 'IVA' || header === 'Total' || header === 'Precio') {
                        columnWidth = '100px';
                    } else if (header === 'Fecha') {
                        columnWidth = '90px';
                    } else if (header === 'Serie' || header === 'Número' || header === 'Cantidad') {
                        columnWidth = '70px';
                    } else if (header === 'NIF' || header === 'CP') {
                        columnWidth = '90px';
                    } else if (header === 'Email') {
                        columnWidth = '180px';
                    } else if (header === 'Ciudad' || header === 'Provincia') {
                        columnWidth = '120px';
                    } else {
                        columnWidth = '100px';
                    }
                }
                
                th.style.width = columnWidth;
                // Si hay ancho personalizado, aplicar min y max también
                if (customColumnWidths[header]) {
                    th.style.minWidth = columnWidth;
                    th.style.maxWidth = columnWidth;
                }
                
                // Quitar el onclick del th
                // Determinar flecha, clase y número de prioridad
                let sortArrow = '↕'; // Flecha por defecto (sin ordenar)
                let sortClass = 'sort-none';
                let priorityNumber = '';
                
                // Buscar si esta columna está en el ordenamiento múltiple
                const multiSortIndex = multiSortColumns.findIndex(col => col.column === header);
                
                if (multiSortIndex >= 0) {
                    // La columna está en ordenamiento múltiple
                    const sortConfig = multiSortColumns[multiSortIndex];
                    if (sortConfig.direction === 'asc') {
                        sortArrow = '⬆';
                        sortClass = 'sort-asc';
                    } else if (sortConfig.direction === 'desc') {
                        sortArrow = '⬇';
                        sortClass = 'sort-desc';
                    }
                    // Mostrar número de prioridad solo si hay más de una columna ordenada
                    if (multiSortColumns.length > 1) {
                        priorityNumber = `<span class="sort-priority">${multiSortIndex + 1}</span>`;
                    }
                } else if (sortStates[header] && sortStates[header] !== 'none') {
                    // Compatibilidad con ordenamiento simple (sin CTRL)
                    if (sortStates[header] === 'asc') {
                        sortArrow = '⬆';
                        sortClass = 'sort-asc';
                    } else if (sortStates[header] === 'desc') {
                        sortArrow = '⬇';
                        sortClass = 'sort-desc';
                    }
                }
                
                th.innerHTML = `
                    <span class="header-text" onclick="sortByColumn('${header}', event)" style="cursor: pointer;">
                        <span class="header-title">${header}${priorityNumber}</span>
                        <span class="sort-indicator ${sortClass}">${sortArrow}</span>
                    </span>
                    <span class="filter-icon ${columnFilters[header] ? 'active' : ''}" onclick="event.stopPropagation(); showFilterMenu('${header}', event)" title="Filtrar">⋮</span>
                `;
                th.style.cursor = 'default';
                
                // Añadir doble clic en la cabecera para autoajuste
                th.addEventListener('dblclick', (e) => {
                    // Solo activar si no se está haciendo clic en otros elementos como filtros
                    if (e.target.classList.contains('filter-icon') || 
                        e.target.classList.contains('sort-icon') ||
                        e.target.closest('.column-resizer')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    autoResizeColumn(th);
                });

                // Añadir manejador de redimensionado
                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                
                // Simplificar el manejo del resizer - solo para redimensionar
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    initResize(e, th);
                });
                
                // También permitir doble clic en el resizer para autoajuste
                resizer.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    autoResizeColumn(th);
                });
                
                th.appendChild(resizer);
                
                tr.appendChild(th);
            });
            
            
            headerRow.appendChild(tr);
            
            // Crear filas - con soporte para agrupación
            if (groupByColumn && Object.keys(groupedData).length > 0) {
                // Renderizar filas agrupadas
                Object.entries(groupedData).forEach(([groupValue, groupItems]) => {
                    // Crear fila de grupo
                    const groupRow = createGroupRow(groupValue, groupItems);
                    body.appendChild(groupRow);
                    
                    // Crear filas de items si el grupo está expandido
                    if (expandedGroups.has(groupValue)) {
                        groupItems.forEach((invoice, index) => {
                            const row = createRow(invoice, index, true); // true = fila de grupo
                            body.appendChild(row);
                        });
                    }
                });
            } else {
                // Renderizar filas normales
                filteredData.forEach((invoice, index) => {
                    const row = createRow(invoice, index);
                    body.appendChild(row);
                });
            }
            
            // Actualizar checkbox de seleccionar todo
            updateSelectAllCheckbox();
            
            // Calcular y mostrar totales después de renderizar el grid
            setTimeout(() => {
                calculateStats();
                // Asegurar que la barra sea visible
                const statsBar = document.getElementById('statsBar');
                if (statsBar) {
                    statsBar.style.display = 'flex';
                    statsBar.style.visibility = 'visible';
                    statsBar.style.opacity = '1';
                }
                // Actualizar botón de mostrar columnas
                updateShowColumnsButton();
            }, 100);
        }

        // Crear fila de grupo
        function createGroupRow(groupValue, groupItems) {
            const tr = document.createElement('tr');
            tr.className = 'group-row';
            tr.style.backgroundColor = '#f8f9fa';
            tr.style.fontWeight = 'bold';
            tr.style.cursor = 'pointer';
            
            // Celda del checkbox (vacía para grupos)
            const checkboxTd = document.createElement('td');
            checkboxTd.className = 'checkbox-cell';
            tr.appendChild(checkboxTd);
            
            // Calcular totales del grupo
            const totals = calculateGroupTotals(groupItems);
            
            // Crear celda principal que ocupa todas las columnas visibles
            const mainTd = document.createElement('td');
            const visibleColumnsCount = headers.filter(header => !hiddenColumns.has(header)).length;
            mainTd.colSpan = visibleColumnsCount;
            
            const isExpanded = expandedGroups.has(groupValue);
            const expandIcon = isExpanded ? '▼' : '▶';
            
            // Formatear el valor del grupo si es una fecha
            let displayValue = groupValue;
            if (groupByColumn === 'Fecha' && groupValue && groupValue !== 'Sin valor') {
                try {
                    const fechaData = processFechaHora(groupValue.toString());
                    displayValue = fechaData.solo_fecha;
                } catch (error) {
                    // Si hay error al procesar la fecha, mantener el valor original
                    console.warn('Error al formatear fecha en grupo:', groupValue, error);
                }
            }
            
            // Crear texto con operaciones de columnas seleccionadas
            let operationsText = '';
            if (selectedSumColumns.size > 0) {
                const results = calculateSelectedColumnsSums(groupItems);
                const operationsParts = [];
                selectedSumColumns.forEach(column => {
                    if (results[column] !== undefined && results[column] !== null) {
                        const operation = columnOperations[column] || 'sum';
                        const operationLabel = operation.charAt(0).toUpperCase() + operation.slice(1);
                        operationsParts.push(`${operationLabel}(${column}): ${results[column]}`);
                    }
                });
                if (operationsParts.length > 0) {
                    operationsText = ` - ${operationsParts.join(' - ')}`;
                }
            }
            
            mainTd.innerHTML = `
                <span style="margin-right: 8px;">${expandIcon}</span>
                <strong>${displayValue}</strong>
                <span style="margin-left: 10px; color: #666; font-weight: normal;">
                    (${groupItems.length} líneas${operationsText})
                </span>
            `;
            
            mainTd.onclick = () => toggleGroup(groupValue);
            tr.appendChild(mainTd);
            
            return tr;
        }
        
        // Calcular totales de un grupo
        function calculateGroupTotals(groupItems) {
            let total = 0;
            let baseImponible = 0;
            let iva = 0;
            
            groupItems.forEach(item => {
                if (item['Total']) {
                    const totalValue = parseNumberES(item['Total'].toString());
                    if (!isNaN(totalValue)) total += totalValue;
                }
                if (item['Base Imponible']) {
                    const baseValue = parseNumberES(item['Base Imponible'].toString());
                    if (!isNaN(baseValue)) baseImponible += baseValue;
                }
                if (item['IVA']) {
                    const ivaValue = parseNumberES(item['IVA'].toString());
                    if (!isNaN(ivaValue)) iva += ivaValue;
                }
            });
            
            return {
                total: total > 0 ? formatNumber(total) : null,
                baseImponible: baseImponible > 0 ? formatNumber(baseImponible) : null,
                iva: iva > 0 ? formatNumber(iva) : null
            };
        }
        
        // Calcular operaciones de las columnas seleccionadas
        function calculateSelectedColumnsSums(groupItems) {
            const results = {};
            
            selectedSumColumns.forEach(column => {
                const operation = columnOperations[column] || 'sum';
                const values = [];
                
                // Recopilar valores válidos
                groupItems.forEach(item => {
                    if (item[column]) {
                        const value = parseNumberES(item[column].toString());
                        if (!isNaN(value)) {
                            values.push(value);
                        }
                    }
                });
                
                if (values.length > 0) {
                    let result;
                    switch (operation) {
                        case 'sum':
                            result = values.reduce((a, b) => a + b, 0);
                            break;
                        case 'count':
                            result = values.length;
                            break;
                        case 'max':
                            result = Math.max(...values);
                            break;
                        case 'min':
                            result = Math.min(...values);
                            break;
                        case 'avg':
                            result = values.reduce((a, b) => a + b, 0) / values.length;
                            break;
                        default:
                            result = values.reduce((a, b) => a + b, 0);
                    }
                    
                    // Formatear resultado según la operación
                    if (operation === 'count') {
                        results[column] = result.toString();
                    } else {
                        results[column] = formatNumber(result);
                    }
                }
            });
            
            return results;
        }
        
        // Crear una fila
        function createRow(invoice, index, isGrouped = false) {
            const tr = document.createElement('tr');
            tr.dataset.index = index;
            tr.dataset.row = invoice.rowNumber;
            
            // Checkbox de selección
            const checkboxTd = document.createElement('td');
            checkboxTd.className = 'checkbox-cell';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selectedRows.has(invoice.rowNumber);
            checkbox.onchange = (e) => toggleRowSelection(invoice.rowNumber, e);
            checkboxTd.appendChild(checkbox);
            tr.appendChild(checkboxTd);
            
            // Datos (filtrar columnas ocultas)
            headers.filter(header => !hiddenColumns.has(header)).forEach((header, colIndex) => {
                const td = document.createElement('td');
                let value = invoice[header] || '';
                
                // Formatear fecha en formato español
                if (header === 'Fecha' && value) {
                    try {
                        const fechaData = processFechaHora(value.toString());
                        value = fechaData.solo_fecha;
                    } catch (error) {
                        // Si hay error al procesar la fecha, mantener el valor original
                        console.warn('Error al formatear fecha:', value, error);
                    }
                    td.className = 'editable';
                }
                // Aplicar clase especial para números
                else if (header === 'Base Imponible' || header === 'IVA' || header === 'Total' || header === 'Cantidad' || header === 'Precio') {
                    td.className = 'number-cell editable';
                    // Formatear números con formato español
                    if (value) {
                        const num = parseNumberES(value.toString());
                        if (!isNaN(num)) {
                            value = formatNumber(num);
                        }
                    }
                } else {
                    td.className = 'editable';
                }
                
                // Si es una fila agrupada y es la primera columna, añadir indentación
                if (isGrouped && colIndex === 0) {
                    td.innerHTML = `<span style="margin-left: 20px;">${value}</span>`;
                    tr.style.backgroundColor = '#fdfdfd';
                } else {
                    td.textContent = value;
                }
                
                td.dataset.column = colIndex + 1;
                td.contentEditable = false;
                td.ondblclick = () => enableEdit(td, invoice.rowNumber, colIndex + 1);
                tr.appendChild(td);
            });
            
            return tr;
        }

        // Seleccionar fila
        function selectRow(tr, event) {
            if (event.target.tagName === 'BUTTON' || event.target.contentEditable === 'true') return;
            
            // Quitar selección anterior
            document.querySelectorAll('#gridBody tr').forEach(row => {
                row.classList.remove('selected');
            });
            
            // Seleccionar nueva fila
            tr.classList.add('selected');
            selectedRow = tr;
            
            const index = tr.dataset.index;
            const invoice = invoicesData[index];
            document.getElementById('selectedInfo').textContent = 
                `Seleccionado: ${invoice['Serie']}-${invoice['Número']} - ${invoice['Cliente']}`;
        }

        // Buscar facturas mejorado
        function searchInvoices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // Mostrar/ocultar botón de limpiar
            if (clearBtn) {
                clearBtn.style.display = searchTerm ? 'block' : 'none';
            }
            
            // Primero aplicar búsqueda global
            if (!searchTerm) {
                filteredData = [...invoicesData];
            } else {
                filteredData = invoicesData.filter(invoice => {
                    return Object.values(invoice).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Luego aplicar filtros de columna
            Object.entries(columnFilters).forEach(([column, filter]) => {
                filteredData = filteredData.filter(invoice => {
                    const value = invoice[column] || '';
                    const strValue = value.toString().toLowerCase();
                    const filterValue = filter.value.toLowerCase();
                    
                    switch (filter.condition) {
                        case 'contains':
                            return strValue.includes(filterValue);
                        case 'not_contains':
                            return !strValue.includes(filterValue);
                        case 'equals':
                            return strValue === filterValue;
                        case 'not_equals':
                            return strValue !== filterValue;
                        case 'starts_with':
                            return strValue.startsWith(filterValue);
                        case 'ends_with':
                            return strValue.endsWith(filterValue);
                        case 'greater_than':
                            return parseFloat(value.toString().replace(',', '.')) > parseFloat(filter.value.replace(',', '.'));
                        case 'less_than':
                            return parseFloat(value.toString().replace(',', '.')) < parseFloat(filter.value.replace(',', '.'));
                        case 'greater_equal':
                            return parseFloat(value.toString().replace(',', '.')) >= parseFloat(filter.value.replace(',', '.'));
                        case 'less_equal':
                            return parseFloat(value.toString().replace(',', '.')) <= parseFloat(filter.value.replace(',', '.'));
                        default:
                            return true;
                    }
                });
            });
            
            // Si hay agrupación activa, reagrupar los datos filtrados
            if (groupByColumn) {
                groupData();
            }
            
            renderGrid();
            updateStatus();
            
            // DESACTIVADO: Autoajustar columnas después del filtrado (para debug)
            // setTimeout(() => {
            //     autoResizeAllColumnsAfterFilter();
            // }, 100); // Pequeño delay para asegurar que el DOM esté actualizado
            
            // Mostrar/ocultar botón de limpiar filtros
            const clearAllBtn = document.getElementById('clearAllFiltersBtn');
            if (clearAllBtn) {
                clearAllBtn.style.display = Object.keys(columnFilters).length > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Limpiar búsqueda
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchInvoices();
        }

        // Ordenar por columna con tres estados y soporte para multi-columna
        function sortByColumn(column, event) {
            const isCtrlPressed = event && event.ctrlKey;
            
            // Inicializar estado si no existe
            if (!sortStates[column]) {
                sortStates[column] = 'none';
            }
            
            if (isCtrlPressed) {
                // Modo multi-columna con CTRL
                const existingIndex = multiSortColumns.findIndex(col => col.column === column);
                
                if (existingIndex >= 0) {
                    // La columna ya está en el ordenamiento múltiple, cambiar su dirección
                    const currentState = multiSortColumns[existingIndex].direction;
                    let nextState;
                    
                    if (currentState === 'asc') {
                        nextState = 'desc';
                    } else if (currentState === 'desc') {
                        // Eliminar de multi-ordenamiento
                        multiSortColumns.splice(existingIndex, 1);
                        sortStates[column] = 'none';
                    }
                    
                    if (nextState) {
                        multiSortColumns[existingIndex].direction = nextState;
                        sortStates[column] = nextState;
                    }
                } else {
                    // Añadir nueva columna al ordenamiento múltiple
                    multiSortColumns.push({ column: column, direction: 'asc' });
                    sortStates[column] = 'asc';
                }
            } else {
                // Modo normal sin CTRL - resetear todo y ordenar solo por esta columna
                multiSortColumns = [];
                
                // Ciclar entre los estados: none -> asc -> desc -> none
                const currentState = sortStates[column];
                let nextState;
                
                if (currentState === 'none') {
                    nextState = 'asc';
                } else if (currentState === 'asc') {
                    nextState = 'desc';
                } else if (currentState === 'desc') {
                    nextState = 'none';
                } else {
                    nextState = 'asc';
                }
                
                // Resetear todos los estados
                Object.keys(sortStates).forEach(col => {
                    sortStates[col] = 'none';
                });
                
                if (nextState !== 'none') {
                    sortStates[column] = nextState;
                    multiSortColumns = [{ column: column, direction: nextState }];
                }
                
                sortColumn = nextState !== 'none' ? column : null;
                sortDirection = nextState;
            }
            
            // Aplicar el ordenamiento
            applyMultiSort();
            renderGrid();
            updateSaveSortButton();
        }
        
        // Función para aplicar ordenamiento múltiple
        function applyMultiSort() {
            if (multiSortColumns.length === 0) {
                // Restaurar orden original
                const originalIndexMap = new Map();
                originalDataOrder.forEach((item, index) => {
                    originalIndexMap.set(item.rowNumber, index);
                });
                
                filteredData.sort((a, b) => {
                    const indexA = originalIndexMap.get(a.rowNumber) || 0;
                    const indexB = originalIndexMap.get(b.rowNumber) || 0;
                    return indexA - indexB;
                });
            } else {
                // Ordenamiento múltiple
                filteredData.sort((a, b) => {
                    for (let sortConfig of multiSortColumns) {
                        let valueA = a[sortConfig.column] || '';
                        let valueB = b[sortConfig.column] || '';
                        
                        // Convertir a números si es una columna numérica
                        if (['Base Imponible', 'IVA', 'Total', 'Cantidad', 'Precio'].includes(sortConfig.column)) {
                            valueA = parseNumberES(valueA);
                            valueB = parseNumberES(valueB);
                        } else {
                            valueA = valueA.toString().toLowerCase();
                            valueB = valueB.toString().toLowerCase();
                        }
                        
                        let comparison = 0;
                        if (valueA < valueB) comparison = -1;
                        else if (valueA > valueB) comparison = 1;
                        
                        if (comparison !== 0) {
                            return sortConfig.direction === 'asc' ? comparison : -comparison;
                        }
                    }
                    return 0;
                });
            }
        }
        
        // Actualizar visibilidad del botón de guardar orden
        function updateSaveSortButton() {
            const btn = document.getElementById('saveSortBtn');
            if (btn) {
                // Mostrar el botón solo si hay ordenamiento activo (diferente del inicial)
                const hasCustomSort = multiSortColumns.length > 0 && 
                    !(multiSortColumns.length === 2 && 
                      multiSortColumns[0].column === 'Serie' && 
                      multiSortColumns[0].direction === 'asc' &&
                      multiSortColumns[1].column === 'Fecha' && 
                      multiSortColumns[1].direction === 'asc');
                btn.style.display = hasCustomSort ? 'inline-block' : 'none';
            }
        }
        
        // Guardar ordenamiento actual en Google Sheets
        function saveSortToSheets() {
            if (!confirm('¿Desea guardar el orden actual de las facturas en Google Sheets? Esta operación reordenará físicamente las filas.')) {
                return;
            }
            
            // Preparar datos para enviar
            const sortedData = filteredData.map(invoice => {
                const row = {};
                headers.forEach(header => {
                    row[header] = invoice[header] || '';
                });
                row.rowNumber = invoice.rowNumber;
                return row;
            });
            
            // Enviar al servidor
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'reorderRows',
                    data: sortedData,
                    headers: headers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    // Recargar datos para reflejar el nuevo orden
                    loadInvoices();
                } else {
                    console.error('Error al guardar ordenamiento:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Funciones de selección múltiple
        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox.checked) {
                filteredData.forEach(invoice => {
                    selectedRows.add(invoice.rowNumber);
                });
            } else {
                selectedRows.clear();
            }
            renderGrid();
            updateSelectionInfo();
        }

        function toggleRowSelection(rowNumber, event) {
            event.stopPropagation();
            
            // Encontrar la factura que se está seleccionando/deseleccionando
            const currentInvoice = invoicesData.find(inv => inv.rowNumber === rowNumber);
            if (!currentInvoice) {
                return;
            }
            
            const currentSerie = currentInvoice['Serie'];
            const currentNumero = currentInvoice['Número'];
            
            if (selectedRows.has(rowNumber)) {
                // Deseleccionar: quitar esta factura y todas las que tengan la misma serie y número
                const relatedInvoices = invoicesData.filter(inv => 
                    inv['Serie'] === currentSerie && inv['Número'] === currentNumero
                );
                
                relatedInvoices.forEach(invoice => {
                    selectedRows.delete(invoice.rowNumber);
                });
            } else {
                // Seleccionar: añadir esta factura y todas las que tengan la misma serie y número
                const relatedInvoices = invoicesData.filter(inv => 
                    inv['Serie'] === currentSerie && inv['Número'] === currentNumero
                );
                
                relatedInvoices.forEach(invoice => {
                    selectedRows.add(invoice.rowNumber);
                });
            }
            
            // Actualizar la vista del grid para reflejar los cambios
            renderGrid();
            updateSelectionInfo();
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox) {
                const allSelected = filteredData.length > 0 && 
                    filteredData.every(invoice => selectedRows.has(invoice.rowNumber));
                checkbox.checked = allSelected;
            }
        }

        function updateSelectionInfo() {
            document.getElementById('selectedCountGrid').textContent = 
                `${selectedRows.size} filas seleccionadas`;
            
            // Mostrar/ocultar botón de eliminar
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.style.display = selectedRows.size > 0 ? 'inline-block' : 'none';
            }
        }

        // Eliminar facturas seleccionadas (VERSIÓN MASIVA OPTIMIZADA)
        function deleteSelectedInvoices() {
            if (selectedRows.size === 0) {
                return;
            }

            // Calcular total de facturas seleccionadas
            const totalSeleccionado = selectedRows.size;

            if (!confirm(`¿Está seguro de que desea eliminar ${totalSeleccionado} factura(s)?`)) {
                return;
            }

            // Convertir Set a Array para envío masivo
            const rowsToDelete = Array.from(selectedRows);
            


            // ELIMINACIÓN MASIVA EN UNA SOLA PETICIÓN
            const url = `${WEB_APP_URL}?action=delete&rows=${encodeURIComponent(JSON.stringify(rowsToDelete))}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Limpiar selección inmediatamente
                    selectedRows.clear();
                    
                    if (data.result === 'success') {
                        const deletedCount = data.deletedCount || rowsToDelete.length;
                        // Eliminación masiva completada exitosamente
                    } else {
                        console.error('❌ Error en eliminación masiva:', data.error);
                    }
                    
                    // Recargar datos después de un breve delay
                    setTimeout(() => {
                        loadInvoices();
                    }, 300);
                })
                .catch(error => {
                    console.error('❌ Error crítico en eliminación masiva:', error);
                    
                    // En caso de error de red, intentar método de respaldo (una por una)
                    // Usando método de respaldo para eliminación individual
                    deleteSelectedInvoicesBackup(rowsToDelete);
                });
        }

        // Método de respaldo: eliminación una por una (solo si falla la masiva)
        async function deleteSelectedInvoicesBackup(rowsToDelete) {
            // Ordenar de mayor a menor para eliminar desde abajo hacia arriba
            const sortedRows = rowsToDelete.sort((a, b) => b - a);
            let successCount = 0;
            let errorCount = 0;

            for (const rowNumber of sortedRows) {
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=delete&row=${rowNumber}`);
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        successCount++;
        
                    } else {
                        errorCount++;
                        console.error(`❌ Error al eliminar fila ${rowNumber}:`, data.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`❌ Error de red al eliminar fila ${rowNumber}:`, error);
                }
                
                // Pausa breve entre eliminaciones
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Limpiar selección y recargar datos
            selectedRows.clear();
            setTimeout(() => {
                loadInvoices();
            }, 500);
        }

        // Mostrar menú de filtros
        function showFilterMenu(column, event) {
            event.stopPropagation();
            

            
            // Cerrar otros menús
            document.querySelectorAll('.filter-menu').forEach(menu => menu.remove());
            
            // Crear menú
            const menu = document.createElement('div');
            menu.className = 'filter-menu';
            menu.style.position = 'fixed';
            menu.style.display = 'block';
            menu.tabIndex = -1;
            
            // Calcular posición para que no se salga de la pantalla
            const menuWidth = 250; // Ancho aproximado del menú
            const menuHeight = 400; // Alto aproximado del menú
            
            let left = event.clientX - 200;
            let top = event.clientY;
            
            // Ajustar horizontalmente
            if (left < 10) {
                left = 10; // Margen izquierdo
            } else if (left + menuWidth > window.innerWidth - 10) {
                left = window.innerWidth - menuWidth - 10; // Margen derecho
            }
            
            // Ajustar verticalmente
            if (top + menuHeight > window.innerHeight - 10) {
                top = window.innerHeight - menuHeight - 10; // Margen inferior
            }
            if (top < 10) {
                top = 10; // Margen superior
            }
            
            menu.style.top = top + 'px';
            menu.style.left = left + 'px';
            
            const isNumeric = ['Base Imponible', 'IVA', 'Total', 'Cantidad', 'Precio'].includes(column);
            
            // Obtener valores actuales del filtro si existe
            const currentFilter = columnFilters[column] || { condition: 'contains', value: '' };
            
            // Verificar si esta columna está siendo agrupada actualmente
            const isCurrentlyGrouped = groupByColumn === column;
            
            menu.innerHTML = `
                <div class="filter-menu-header">
                    <span>Filtrar: ${column} ${currentFilter.value ? '🔴' : ''}</span>
                    <span class="filter-menu-close" onclick="this.parentElement.parentElement.remove()">×</span>
                </div>
                <div class="filter-menu-content">
                    <div class="filter-group">
                        <label class="hide-column-link" onclick="hideColumn('${column}')" style="cursor: pointer;">Ocultar columna</label>
                        <label class="autofit-column-link" onclick="autofitColumnFromMenu('${column}')" style="cursor: pointer; display: block; margin-top: 5px;">Autoajustar esta columna</label>
                        <label class="autofit-all-link" onclick="autofitAllColumns()" style="cursor: pointer; display: block; margin-top: 5px;">Autoajustar todas las columnas</label>
                    </div>
                    <div class="filter-group" style="text-align: left;">
                        <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; text-align: left; margin-bottom: 4px; white-space: nowrap;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Agrupar por ${column}</span>
                            <input type="checkbox" id="enableGrouping" onchange="toggleGroupingOptions()" style="margin-left: 8px; flex-shrink: 0;" ${isCurrentlyGrouped ? 'checked' : ''}>
                        </label>
                        <div id="groupingOptions" style="display: ${isCurrentlyGrouped ? 'block' : 'none'}; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; text-align: left;">
                            <div style="margin-bottom: 8px; font-weight: 600; color: #555; text-align: left;">Columnas:</div>
                            <div id="numericColumnsContainer" style="text-align: left;"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Condición:</label>
                        <select id="filterCondition" data-column="${column}">
                            <option value="contains" ${currentFilter.condition === 'contains' ? 'selected' : ''}>Contiene</option>
                            <option value="not_contains" ${currentFilter.condition === 'not_contains' ? 'selected' : ''}>No contiene</option>
                            <option value="equals" ${currentFilter.condition === 'equals' ? 'selected' : ''}>Igual a</option>
                            <option value="not_equals" ${currentFilter.condition === 'not_equals' ? 'selected' : ''}>Diferente de</option>
                            <option value="starts_with" ${currentFilter.condition === 'starts_with' ? 'selected' : ''}>Empieza con</option>
                            <option value="ends_with" ${currentFilter.condition === 'ends_with' ? 'selected' : ''}>Termina con</option>
                            ${isNumeric ? `
                            <option value="greater_than" ${currentFilter.condition === 'greater_than' ? 'selected' : ''}>Mayor que</option>
                            <option value="less_than" ${currentFilter.condition === 'less_than' ? 'selected' : ''}>Menor que</option>
                            <option value="greater_equal" ${currentFilter.condition === 'greater_equal' ? 'selected' : ''}>Mayor o igual</option>
                            <option value="less_equal" ${currentFilter.condition === 'less_equal' ? 'selected' : ''}>Menor o igual</option>
                            ` : ''}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Valor:</label>
                        <input type="text" id="filterValue" placeholder="Introduce el valor..." value="${currentFilter.value || ''}" data-column="${column}">
                    </div>
                    <div class="filter-menu-actions">
                        <button class="filter-btn filter-btn-apply" onclick="applyFilter('${column}')">
                            Aplicar
                        </button>
                        <button class="filter-btn filter-btn-clear" onclick="clearFilter('${column}')">
                            Limpiar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Guardar la columna en una variable global temporal
            window.currentFilterColumn = column;
            
            // Agregar evento Enter a todo el menú
            menu.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    e.stopPropagation();
    
                    applyFilter(column);
                }
            });
            
            // Focus en el input y seleccionar el texto si hay valor
            setTimeout(() => {
                const input = menu.querySelector('#filterValue');
                const select = menu.querySelector('#filterCondition');
                
                // Si ya está agrupado, popular las columnas automáticamente
                if (isCurrentlyGrouped) {
                    toggleGroupingOptions();
                }
                
                if (input) {
                    input.focus();
                    if (input.value) {
                        input.select();
                    }
                    
                    // Añadir evento Enter directamente al input
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.keyCode === 13) {
                            e.preventDefault();
                            applyFilter(column);
                        }
                    });
                }
                
                if (select) {
                    // Añadir evento Enter directamente al select
                    select.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.keyCode === 13) {
                            e.preventDefault();
                            applyFilter(column);
                        }
                    });
                }
            }, 200);
        }
        
        // Aplicar filtro
        function applyFilter(column) {
            // Verificar si se está aplicando agrupación
            const enableGroupingCheckbox = document.getElementById('enableGrouping');
            if (enableGroupingCheckbox && enableGroupingCheckbox.checked) {
                // Aplicar agrupación
                applyGrouping(column);
                return;
            }
            
            // Aplicar filtro normal
            const condition = document.getElementById('filterCondition').value;
            const value = document.getElementById('filterValue').value;
            
            if (value) {
                columnFilters[column] = { condition, value };
            } else {
                delete columnFilters[column];
            }
            
            // Cerrar menú
            const menu = document.querySelector('.filter-menu');
            if (menu) {
                window.currentFilterColumn = null; // Limpiar variable global
                menu.remove();
            }
            
            // Aplicar filtros y renderizar
            searchInvoices();
        }
        
        // Limpiar filtro
        function clearFilter(column) {
            delete columnFilters[column];
            const menu = document.querySelector('.filter-menu');
            if (menu) {
                window.currentFilterColumn = null; // Limpiar variable global
                menu.remove();
            }
            searchInvoices();
        }
        
        // Ocultar columna
        function hideColumn(column) {
            hiddenColumns.add(column);
            document.querySelector('.filter-menu').remove();
            searchInvoices(); // Recargar grid
            updateShowColumnsButton(); // Actualizar botón
        }
        
        // Mostrar columna
        function showColumn(column) {
            hiddenColumns.delete(column);
            searchInvoices(); // Recargar grid
            updateShowColumnsButton(); // Actualizar botón
        }
        
        // Mostrar todas las columnas
        function showAllColumns() {
            hiddenColumns.clear();
            searchInvoices(); // Recargar grid
            updateShowColumnsButton(); // Actualizar botón
        }

        // Autoajustar una columna específica (simplificado)
        function autofitColumn(column) {
            // Usar la función optimizada que ya existe
            autofitColumnFromMenu(column);
        }

        // Autoajuste de columna desde menú (usa algoritmo optimizado)
        function autofitColumnFromMenu(column) {
            // Cerrar el menú de filtros
            const menu = document.querySelector('.filter-menu');
            if (menu) {
                menu.remove();
            }

            // Encontrar la columna th correspondiente
            const headerCells = document.querySelectorAll('#gridHeader th:not(.checkbox-cell)');
            let targetTh = null;
            
            for (const th of headerCells) {
                const headerTitle = th.querySelector('.header-title');
                if (headerTitle) {
                    const columnName = headerTitle.childNodes[0] ? headerTitle.childNodes[0].textContent.trim() : '';
                    if (columnName === column) {
                        targetTh = th;
                        break;
                    }
                }
            }
            
            if (!targetTh) {
                showNotification(`Error: Columna "${column}" no encontrada`, 'error');
                return;
            }
            
            // Usar la función de autoajuste optimizada
            autoResizeColumn(targetTh);
        }

        // Autoajustar todas las columnas
        function autofitAllColumns() {
            const table = document.getElementById('invoicesGrid');
            if (!table) return;

            // Cerrar el menú de filtros
            const menu = document.querySelector('.filter-menu');
            if (menu) {
                menu.remove();
            }

            const headers = Array.from(table.querySelectorAll('thead th'));
            let totalAdjusted = 0;

            headers.forEach((header, columnIndex) => {
                const column = header.textContent.trim();
                if (!column) return; // Saltar headers vacíos
                
                // Obtener todas las celdas de esta columna
                const allCells = [
                    header,
                    ...table.querySelectorAll(`tbody td:nth-child(${columnIndex + 1})`)
                ].filter(cell => cell);

                if (allCells.length === 0) return;

                // Crear elemento para medir
                const measurer = document.createElement('div');
                measurer.style.position = 'absolute';
                measurer.style.visibility = 'hidden';
                measurer.style.whiteSpace = 'nowrap';
                measurer.style.fontSize = '14px';
                measurer.style.fontFamily = 'Arial, sans-serif';
                measurer.style.padding = '8px 12px';
                document.body.appendChild(measurer);

                let maxWidth = 0;

                // Medir cada celda
                allCells.forEach(cell => {
                    measurer.textContent = cell.textContent || cell.innerText || '';
                    const width = measurer.offsetWidth;
                    maxWidth = Math.max(maxWidth, width);
                });

                document.body.removeChild(measurer);

                // Calcular ancho final
                const minWidth = 80;
                const maxAllowedWidth = 300;
                const finalWidth = Math.min(Math.max(maxWidth + 20, minWidth), maxAllowedWidth);

                // Aplicar ancho
                header.style.width = finalWidth + 'px';
                header.style.minWidth = finalWidth + 'px';
                header.style.maxWidth = finalWidth + 'px';
                
                const dataCells = table.querySelectorAll(`tbody td:nth-child(${columnIndex + 1})`);
                dataCells.forEach(cell => {
                    cell.style.width = finalWidth + 'px';
                    cell.style.minWidth = finalWidth + 'px';
                    cell.style.maxWidth = finalWidth + 'px';
                });

                totalAdjusted++;
            });

        }
        
        // Actualizar visibilidad del botón de mostrar columnas
        function updateShowColumnsButton() {
            const btn = document.getElementById('show-columns-btn');
            if (btn) {
                btn.style.display = hiddenColumns.size > 0 ? 'block' : 'none';
            }
            
            // También actualizar el botón principal en la barra de herramientas
            const mainBtn = document.getElementById('showAllColumnsBtn');
            if (mainBtn) {
                mainBtn.style.display = hiddenColumns.size > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Mostrar menú de columnas ocultas
        function showColumnsMenu() {
            // Cerrar otros menús
            document.querySelectorAll('.filter-menu').forEach(menu => menu.remove());
            
            if (hiddenColumns.size === 0) {
                return;
            }
            
            // Crear menú
            const menu = document.createElement('div');
            menu.className = 'filter-menu';
            menu.style.position = 'fixed';
            menu.style.top = '100px';
            menu.style.left = '50%';
            menu.style.transform = 'translateX(-50%)';
            menu.style.display = 'block';
            
            let columnsHtml = '';
            hiddenColumns.forEach(column => {
                columnsHtml += `
                    <div class="filter-group" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>${column}</span>
                        <button class="filter-btn filter-btn-apply" onclick="showColumn('${column}'); updateShowColumnsButton();" style="margin-left: 10px; padding: 5px 10px;">
                            Mostrar
                        </button>
                    </div>
                `;
            });
            
            menu.innerHTML = `
                <div class="filter-menu-header">
                    <span>Columnas Ocultas (${hiddenColumns.size})</span>
                    <span class="filter-menu-close" onclick="this.parentElement.parentElement.remove()">×</span>
                </div>
                <div class="filter-menu-content">
                    ${columnsHtml}
                    <div class="filter-menu-actions" style="margin-top: 15px;">
                        <button class="filter-btn filter-btn-apply" onclick="showAllColumns(); updateShowColumnsButton(); this.closest('.filter-menu').remove();">
                            Mostrar Todas
                        </button>
                        <button class="filter-btn filter-btn-cancel" onclick="this.closest('.filter-menu').remove();">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
        }
        
        // Mostrar/ocultar opciones de agrupación
        function toggleGroupingOptions() {
            const checkbox = document.getElementById('enableGrouping');
            const options = document.getElementById('groupingOptions');
            const container = document.getElementById('numericColumnsContainer');
            
            if (checkbox.checked) {
                options.style.display = 'block';
                
                // Obtener columnas numéricas
                const numericColumns = ['Base Imponible', 'IVA', 'Total', 'Cantidad', 'Precio'];
                const availableNumericColumns = headers.filter(header => 
                    numericColumns.includes(header) && !hiddenColumns.has(header)
                );
                
                // Crear checkboxes para columnas numéricas
                container.innerHTML = '';
                availableNumericColumns.forEach(column => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '5px';
                    div.style.textAlign = 'left';
                    
                    // Verificar si esta columna está seleccionada y su operación
                    const isSelected = selectedSumColumns.has(column);
                    const currentOperation = columnOperations[column] || 'sum';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; font-size: 13px;">
                            <span style="flex: 1; padding-right: 10px;">${column}</span>
                            <select id="operation-${column}" style="margin-right: 8px; padding: 2px; font-size: 12px; width: 60px;" onchange="updateColumnOperation('${column}')">
                                <option value="sum" ${currentOperation === 'sum' ? 'selected' : ''}>Sum</option>
                                <option value="count" ${currentOperation === 'count' ? 'selected' : ''}>Count</option>
                                <option value="max" ${currentOperation === 'max' ? 'selected' : ''}>Max</option>
                                <option value="min" ${currentOperation === 'min' ? 'selected' : ''}>Min</option>
                                <option value="avg" ${currentOperation === 'avg' ? 'selected' : ''}>Avg</option>
                            </select>
                            <input type="checkbox" value="${column}" onchange="updateSelectedSumColumns()" style="margin-left: 4px;" ${isSelected ? 'checked' : ''}>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                if (availableNumericColumns.length === 0) {
                    container.innerHTML = '<div style="color: #666; font-style: italic; text-align: left; padding: 5px;">No hay columnas numéricas disponibles</div>';
                }
            } else {
                options.style.display = 'none';
                selectedSumColumns.clear();
            }
        }
        
        // Actualizar columnas seleccionadas para sumar
        function updateSelectedSumColumns() {
            selectedSumColumns.clear();
            const checkboxes = document.querySelectorAll('#numericColumnsContainer input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedSumColumns.add(checkbox.value);
                // Asegurar que la operación esté definida
                if (!columnOperations[checkbox.value]) {
                    columnOperations[checkbox.value] = 'sum';
                }
            });
        }
        
        // Actualizar operación de columna
        function updateColumnOperation(column) {
            const select = document.getElementById(`operation-${column}`);
            if (select) {
                columnOperations[column] = select.value;
            }
        }
        
        // Aplicar agrupación con sumas
        function applyGrouping(column) {
            const checkbox = document.getElementById('enableGrouping');
            if (!checkbox.checked) {
                return;
            }
            
            groupByColumn = column;
            document.querySelector('.filter-menu').remove();
            
            // Mover la columna agrupada al primer lugar
            moveColumnToFirst(column);
            
            // Agrupar los datos
            groupData();
            
            // Renderizar grid agrupado
            searchInvoices();
            
            // Actualizar botón de desagrupar
            updateUngroupButton();
        }
        
        // Agrupar por columna (función original mantenida para compatibilidad)
        function groupByColumnFunc(column) {
            selectedSumColumns.clear(); // Limpiar sumas al usar método simple
            columnOperations = {}; // Limpiar operaciones al usar método simple
            groupByColumn = column;
            document.querySelector('.filter-menu').remove();
            
            // Mover la columna agrupada al primer lugar
            moveColumnToFirst(column);
            
            // Agrupar los datos
            groupData();
            
            // Renderizar grid agrupado
            searchInvoices();
            
            // Actualizar botón de desagrupar
            updateUngroupButton();
        }
        
        // Mover columna al primer lugar
        function moveColumnToFirst(column) {
            const index = headers.indexOf(column);
            if (index > 0) {
                // Remover la columna de su posición actual
                headers.splice(index, 1);
                // Insertarla al principio
                headers.unshift(column);
            }
        }
        
        // Agrupar datos
        function groupData() {
            if (!groupByColumn) return;
            
            groupedData = {};
            expandedGroups.clear();
            
            filteredData.forEach(item => {
                const groupValue = item[groupByColumn] || 'Sin valor';
                if (!groupedData[groupValue]) {
                    groupedData[groupValue] = [];
                }
                groupedData[groupValue].push(item);
            });
            
            // Expandir todos los grupos por defecto
            Object.keys(groupedData).forEach(group => {
                expandedGroups.add(group);
            });
        }
        
        // Desagrupar
        function ungroupData() {
            groupByColumn = null;
            groupedData = {};
            expandedGroups.clear();
            selectedSumColumns.clear(); // Limpiar columnas seleccionadas para sumar
            columnOperations = {}; // Limpiar operaciones de columnas
            searchInvoices();
            updateUngroupButton();
        }
        
        // Alternar expansión de grupo
        function toggleGroup(groupValue) {
            if (expandedGroups.has(groupValue)) {
                expandedGroups.delete(groupValue);
            } else {
                expandedGroups.add(groupValue);
            }
            renderGrid();
        }
        
        // Actualizar botón de desagrupar
        function updateUngroupButton() {
            const btn = document.getElementById('ungroupBtn');
            if (btn) {
                btn.style.display = groupByColumn ? 'inline-block' : 'none';
            }
        }
        
        // Limpiar todos los filtros
        function clearAllFilters() {
            // Limpiar filtros de columna
            columnFilters = {};
            
            // Resetear ordenamiento
            sortStates = {};
            multiSortColumns = [];
            sortColumn = null;
            sortDirection = 'asc';
            
            // Limpiar búsqueda global
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Restaurar orden original
            filteredData = [...originalDataOrder];
            
            // Renderizar grid para mostrar cambios
            renderGrid();
            updateStatus();
            updateSaveSortButton();
        }
        
        // Funciones de redimensionado de columnas
        let isResizing = false;
        let currentTh = null;
        let startX = 0;
        let startWidth = 0;
        
        function initResize(e, th) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            currentTh = th;
            startX = e.clientX;
            startWidth = th.offsetWidth;
            
            // Añadir clase
            document.body.classList.add('resizing');
            
            // Añadir eventos temporales
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        function doResize(e) {
            if (!isResizing) return;
            
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff); // Mínimo 50px
            
            // Aplicar el nuevo ancho
            currentTh.style.width = newWidth + 'px';
            currentTh.style.minWidth = newWidth + 'px';
            currentTh.style.maxWidth = newWidth + 'px';
            
            // Guardar el ancho personalizado
            const headerTitle = currentTh.querySelector('.header-title');
            if (headerTitle) {
                // Obtener solo el texto del nombre de la columna (sin números ni flechas)
                const columnName = headerTitle.childNodes[0].textContent.trim();
                customColumnWidths[columnName] = newWidth + 'px';
            }
            
            // Prevenir selección de texto durante el redimensionado
            e.preventDefault();
        }
        
        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            currentTh = null;
            
            // Quitar clase
            document.body.classList.remove('resizing');
            
            // Quitar eventos temporales
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            
            // Forzar actualización del layout
            document.getElementById('invoicesGrid').style.width = '100%';
        }
        
        // Autoajuste optimizado de columna con doble clic
        function autoResizeColumn(th) {
            const headerTitle = th.querySelector('.header-title');
            if (!headerTitle) return;
            
            const columnName = headerTitle.childNodes[0] ? headerTitle.childNodes[0].textContent.trim() : '';
            if (!columnName) return;
            
            const columnIndex = headers.indexOf(columnName);
            if (columnIndex === -1) return;
            
            // Calcular el ancho máximo necesario
            let maxWidth = 0;
            
            // Medir el ancho del header (texto + iconos)
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.fontSize = getComputedStyle(th).fontSize || '12px';
            tempSpan.style.fontWeight = '600';
            tempSpan.style.whiteSpace = 'nowrap';
            tempSpan.style.fontFamily = getComputedStyle(th).fontFamily;
            tempSpan.textContent = columnName + ' ↕⋮'; // Incluir espacio para iconos
            document.body.appendChild(tempSpan);
            const headerWidth = tempSpan.offsetWidth + 80; // +80 para padding, iconos y resizer
            maxWidth = Math.max(maxWidth, headerWidth);
            document.body.removeChild(tempSpan);
            
            // Medir el ancho del contenido de las celdas visibles
            const rows = document.querySelectorAll('#gridBody tr:not(.group-row)');
            const maxRowsToCheck = Math.min(rows.length, 100);
            
            for (let i = 0; i < maxRowsToCheck; i++) {
                const row = rows[i];
                const cell = row.children[columnIndex + 1]; // +1 por el checkbox
                if (cell && cell.textContent.trim()) {
                    const cellText = cell.textContent.trim();
                    const tempSpan = document.createElement('span');
                    tempSpan.style.visibility = 'hidden';
                    tempSpan.style.position = 'absolute';
                    tempSpan.style.fontSize = getComputedStyle(cell).fontSize || '12px';
                    tempSpan.style.whiteSpace = 'nowrap';
                    tempSpan.style.fontFamily = getComputedStyle(cell).fontFamily;
                    tempSpan.textContent = cellText;
                    document.body.appendChild(tempSpan);
                    const cellWidth = tempSpan.offsetWidth + 20; // +20 para padding de celda
                    maxWidth = Math.max(maxWidth, cellWidth);
                    document.body.removeChild(tempSpan);
                }
            }
            
            // Aplicar el nuevo ancho (mínimo 80px, máximo 600px) + margen extra
            const extraWidth = 10;
            const minWidth = 80;
            const maxWidthLimit = 600;
            const newWidth = Math.min(Math.max(maxWidth + extraWidth, minWidth), maxWidthLimit);
            
            // Aplicar el estilo
            th.style.width = newWidth + 'px';
            th.style.minWidth = newWidth + 'px';
            th.style.maxWidth = newWidth + 'px';
            
            // Guardar el ancho personalizado
            if (!customColumnWidths) {
                window.customColumnWidths = {};
            }
            customColumnWidths[columnName] = newWidth + 'px';
        }
        
        // Autoajustar todas las columnas visibles después del filtrado
        function autoResizeAllColumnsAfterFilter() {
            const headerCells = document.querySelectorAll('#gridHeader th:not(.checkbox-cell)');
            
            headerCells.forEach((th) => {
                const headerTitle = th.querySelector('.header-title');
                if (!headerTitle) return;
                
                const columnName = headerTitle.childNodes[0].textContent.trim();
                const columnIndex = headers.indexOf(columnName);
                
                if (columnIndex === -1) return;
                
                // Calcular el ancho máximo necesario
                let maxWidth = 0;
                
                // Medir el ancho del header (texto + iconos)
                const tempSpan = document.createElement('span');
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.position = 'absolute';
                tempSpan.style.fontSize = '12px';
                tempSpan.style.fontWeight = '600';
                tempSpan.style.whiteSpace = 'nowrap';
                tempSpan.style.fontFamily = getComputedStyle(th).fontFamily;
                tempSpan.textContent = columnName + ' ↕'; // Incluir espacio para la flecha
                document.body.appendChild(tempSpan);
                const headerWidth = tempSpan.offsetWidth + 70; // +70 para padding, iconos
                maxWidth = Math.max(maxWidth, headerWidth);
                document.body.removeChild(tempSpan);
                
                // Medir el ancho del contenido de las celdas visibles
                const rows = document.querySelectorAll('#gridBody tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cell = row.children[columnIndex + 1]; // +1 por el checkbox
                    if (cell && cell.textContent.trim()) {
                        const cellText = cell.textContent.trim();
                        const tempSpan = document.createElement('span');
                        tempSpan.style.visibility = 'hidden';
                        tempSpan.style.position = 'absolute';
                        tempSpan.style.fontSize = '12px';
                        tempSpan.style.whiteSpace = 'nowrap';
                        tempSpan.style.fontFamily = getComputedStyle(cell).fontFamily;
                        tempSpan.textContent = cellText;
                        document.body.appendChild(tempSpan);
                        const cellWidth = tempSpan.offsetWidth + 16; // +16 para padding de celda
                        maxWidth = Math.max(maxWidth, cellWidth);
                        document.body.removeChild(tempSpan);
                    }
                }
                
                // Aplicar el nuevo ancho (mínimo 80px, máximo 500px) + extra
                const extraWidth = 6;
                const minWidth = 80;
                const newWidth = Math.min(Math.max(maxWidth + extraWidth, minWidth), 500);
                th.style.width = newWidth + 'px';
                th.style.minWidth = newWidth + 'px';
                th.style.maxWidth = newWidth + 'px';
                
                // Guardar el ancho personalizado
                customColumnWidths[columnName] = newWidth + 'px';
            });
        }
        
        // Calcular estadísticas
        function calculateStats() {
            let baseTotal = 0;
            let ivaTotal = 0;
            let total = 0;

            // Asegurarse de que filteredData existe y es un array
            if (!Array.isArray(filteredData)) {
                console.error('filteredData no es un array:', filteredData);
                return;
            }

            // Calcular totales
            filteredData.forEach(invoice => {
                // Asegurarse de que los valores existen y son válidos
                const base = parseNumberES(invoice['Base Imponible'] || '0');
                const iva = parseNumberES(invoice['IVA'] || '0');
                const tot = parseNumberES(invoice['Total'] || '0');
                
                if (!isNaN(base)) baseTotal += base;
                if (!isNaN(iva)) ivaTotal += iva;
                if (!isNaN(tot)) total += tot;
            });

            const count = filteredData.length;
            const promedio = count > 0 ? total / count : 0;

            // Actualizar valores con formato español
            const statsBar = document.getElementById('statsBar');
            if (statsBar) {
                document.getElementById('statTotalFacturas').textContent = count;
                document.getElementById('statBaseTotal').textContent = formatNumber(baseTotal) + ' €';
                document.getElementById('statIvaTotal').textContent = formatNumber(ivaTotal) + ' €';
                document.getElementById('statTotalFacturado').textContent = formatNumber(total) + ' €';
                document.getElementById('statPromedio').textContent = formatNumber(promedio) + ' €';
                
                // Asegurar que la barra de estadísticas sea visible
                statsBar.style.display = 'flex';
                statsBar.style.visibility = 'visible';
                statsBar.style.opacity = '1';
            }
        }

        // Actualizar estado
        function updateStatus() {
            document.getElementById('statusText').textContent = 
                `${filteredData.length} de ${invoicesData.length} facturas mostradas`;
        }

        // Actualizar grid
        function refreshGrid() {
            loadInvoices();
        }

        // Cargar factura seleccionada
        function loadSelectedInvoice() {
            // Verificar si hay facturas seleccionadas con checkbox
            if (selectedRows.size === 0) {
                return;
            }
            
            // Obtener la primera factura seleccionada para obtener serie y número
            const firstSelectedRowNumber = Array.from(selectedRows)[0];
            const firstInvoice = invoicesData.find(inv => inv.rowNumber === firstSelectedRowNumber);
            
            if (!firstInvoice) {
                return;
            }
            
            // Obtener serie y número para buscar todas las líneas
            const serie = firstInvoice['Serie'] || 'Sin serie';
            const numero = firstInvoice['Número'] || 'Sin número';
            const cliente = firstInvoice['Cliente'] || 'Sin cliente';
            
            // Buscar todas las líneas de la misma factura (mismo serie y número)
            const allInvoiceLines = invoicesData.filter(inv => 
                inv['Serie'] === serie && inv['Número'] === numero
            );
            
            // Verificar si estamos en una vista de grid abierta en nueva pestaña
            const urlParams = new URLSearchParams(window.location.search);
            const isGridView = urlParams.get('view') === 'grid';
            
            // Si estamos en vista grid (nueva pestaña) y hay un opener
            if (isGridView && window.opener && !window.opener.closed) {
                // Enviar datos a la pestaña padre
                try {
                    window.opener.postMessage({
                        type: 'LOAD_INVOICE',
                        data: allInvoiceLines
                    }, '*');
                    
                    // Técnica para forzar cambio de pestaña
                    window.opener.focus();
                    window.blur();
                    
                    // Intentar varias técnicas para forzar el cambio
                    try {
                        // Disparar eventos en la ventana padre para activarla
                        const evt = new window.opener.Event('focus', { bubbles: true, cancelable: false });
                        window.opener.dispatchEvent(evt);
                    } catch(e) {}
                    
                    // Crear un elemento temporal que fuerce el foco
                    try {
                        const tempLink = window.opener.document.createElement('a');
                        tempLink.style.position = 'fixed';
                        tempLink.style.opacity = '0';
                        tempLink.style.pointerEvents = 'none';
                        window.opener.document.body.appendChild(tempLink);
                        tempLink.focus();
                        window.opener.document.body.removeChild(tempLink);
                    } catch(e) {}
                    
                } catch (error) {
                    console.error('Error al enviar datos a la ventana padre:', error);
                    // Si falla, cargar en esta pestaña
                    loadInvoiceDataMultiLine(allInvoiceLines);
                    toggleGridView();
                }
            } else {
                // Si no hay pestaña padre, cargar normalmente en esta pestaña
                loadInvoiceDataMultiLine(allInvoiceLines);
                toggleGridView();
            }
        }
        
        // Función para recibir datos de factura desde una pestaña hija
        function receiveInvoiceData(allInvoiceLines) {
            // Cargar datos en el formulario
            loadInvoiceDataMultiLine(allInvoiceLines);
            
            // Si el grid está visible, ocultarlo
            const gridSection = document.getElementById('grid-section');
            const mainContainer = document.querySelector('.container');
            if (gridSection && gridSection.style.display !== 'none') {
                toggleGridView();
            }
        }

        // Habilitar edición
        function enableEdit(td, rowNumber, column) {
            const header = headers[column - 1];
            const isNumericColumn = ['Base Imponible', 'IVA', 'Total', 'Cantidad', 'Precio'].includes(header);
            const isFechaColumn = header === 'Fecha';
            
            // Crear input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = td.textContent;
            input.className = 'edit-input';
            
            // Función común para finalizar edición
            function finishEdit() {
                let finalValue;
                let displayValue;
                
                if (isNumericColumn) {
                    const num = parseNumberES(input.value);
                    if (!isNaN(num)) {
                        finalValue = formatNumber(num);
                        displayValue = finalValue;
                    } else {
                        finalValue = input.value;
                        displayValue = input.value;
                    }
                } else if (isFechaColumn) {
                    // Procesar y formatear fecha
                    try {
                        const fechaData = processFechaHora(input.value);
                        displayValue = fechaData.solo_fecha; // Para mostrar en la celda
                        finalValue = fechaData.solo_fecha; // Guardar el valor formateado en Google Sheets
                    } catch (error) {
                        console.warn('Error al procesar fecha:', input.value, error);
                        finalValue = input.value;
                        displayValue = input.value;
                    }
                } else {
                    finalValue = input.value;
                    displayValue = input.value;
                }
                
                td.textContent = displayValue;
                td.contentEditable = false;
                
                // Actualizar en Google Sheets y luego actualizar datos locales
                updateCell(rowNumber, column, finalValue, td, displayValue);
                
                // Mostrar feedback visual
                td.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    td.style.backgroundColor = '';
                }, 1000);
            }
            
            // Función para cancelar edición
            function cancelEdit() {
                // Restaurar valor original
                td.textContent = td.dataset.originalValue || '';
                td.contentEditable = false;
            }
            
            // Guardar valor original para poder cancelar
            td.dataset.originalValue = td.textContent;
            
            // Evento blur (perder foco)
            input.onblur = finishEdit;
            
            // Eventos de teclado
            input.onkeydown = function(e) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        e.stopPropagation();
                        finishEdit();
                        
                        // Mover a la celda de abajo si existe
                        setTimeout(() => {
                            const currentRow = td.parentElement;
                            const nextRow = currentRow.nextElementSibling;
                            if (nextRow && nextRow.tagName === 'TR') {
                                const cellIndex = Array.from(currentRow.children).indexOf(td);
                                const nextCell = nextRow.children[cellIndex];
                                if (nextCell && nextCell.classList.contains('editable')) {
                                    nextCell.dispatchEvent(new Event('dblclick'));
                                }
                            }
                        }, 100);
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        e.stopPropagation();
                        finishEdit();
                        
                        // Mover a la celda de arriba si existe
                        setTimeout(() => {
                            const currentRow = td.parentElement;
                            const prevRow = currentRow.previousElementSibling;
                            if (prevRow && prevRow.tagName === 'TR') {
                                const cellIndex = Array.from(currentRow.children).indexOf(td);
                                const prevCell = prevRow.children[cellIndex];
                                if (prevCell && prevCell.classList.contains('editable')) {
                                    prevCell.dispatchEvent(new Event('dblclick'));
                                }
                            }
                        }, 100);
                        break;
                        
                    case 'ArrowDown':
                        e.preventDefault();
                        e.stopPropagation();
                        finishEdit();
                        
                        // Mover a la celda de abajo si existe
                        setTimeout(() => {
                            const currentRow = td.parentElement;
                            const nextRow = currentRow.nextElementSibling;
                            if (nextRow && nextRow.tagName === 'TR') {
                                const cellIndex = Array.from(currentRow.children).indexOf(td);
                                const nextCell = nextRow.children[cellIndex];
                                if (nextCell && nextCell.classList.contains('editable')) {
                                    nextCell.dispatchEvent(new Event('dblclick'));
                                }
                            }
                        }, 100);
                        break;
                        
                    case 'Escape':
                        e.preventDefault();
                        e.stopPropagation();
                        cancelEdit();
                        break;
                        
                    case 'Tab':
                        e.preventDefault();
                        e.stopPropagation();
                        finishEdit();
                        
                        // Mover a la siguiente celda editable en la misma fila
                        setTimeout(() => {
                            const currentRow = td.parentElement;
                            const cells = Array.from(currentRow.children);
                            const currentIndex = cells.indexOf(td);
                            
                            // Buscar la siguiente celda editable
                            for (let i = currentIndex + 1; i < cells.length; i++) {
                                const nextCell = cells[i];
                                if (nextCell.classList.contains('editable')) {
                                    nextCell.dispatchEvent(new Event('dblclick'));
                                    break;
                                }
                            }
                        }, 100);
                        break;
                }
            };
            
            // Reemplazar contenido
            td.textContent = '';
            td.appendChild(input);
            input.focus();
            input.select();
        }

        // Actualizar celda
        function updateCell(row, col, value, td, displayValue) {
            fetch(`${WEB_APP_URL}?action=update&row=${row}&col=${col}&value=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        // Actualizar datos locales
                        const index = invoicesData.findIndex(inv => inv.rowNumber === row);
                        if (index !== -1) {
                            const header = headers[col - 1];
                            // Guardar el valor guardado en Google Sheets
                            invoicesData[index][header] = value;
                            
                            // También actualizar en filteredData si existe
                            const filteredIndex = filteredData.findIndex(inv => inv.rowNumber === row);
                            if (filteredIndex !== -1) {
                                filteredData[filteredIndex][header] = value;
                            }
                        }
                    } else {
                        // Restaurar valor anterior en caso de error
                        td.textContent = td.dataset.originalValue || displayValue;
                    }
                })
                .catch(error => {
                    // Restaurar valor anterior en caso de error
                    td.textContent = td.dataset.originalValue || displayValue;
                    console.error('Error:', error);
                });
        }

        // Eliminar fila
        function deleteRow(rowNumber, event) {
            event.stopPropagation();
            
            if (!confirm('¿Está seguro de que desea eliminar esta factura?')) {
                return;
            }
            
            fetch(`${WEB_APP_URL}?action=delete&row=${rowNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        loadInvoices(); // Recargar datos
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Función auxiliar para procesar y formatear fecha de factura
        function formatInvoiceDate(fecha) {
            if (!fecha) return '';
            
            try {
                // Convertir a string si no lo es
                const fechaStr = fecha.toString();
                
                // Si ya está en formato dd/mm/yyyy (con o sin hora), retornar como está
                if (fechaStr.includes('/')) return fechaStr;
                
                // Si no, procesar otros formatos
                if (typeof processFechaHora === 'function') {
                    return processFechaHora(fechaStr).con_hora;
                }
                
                // Fallback: si processFechaHora no está disponible, intentar parsear la fecha
                const dateObj = new Date(fechaStr);
                if (!isNaN(dateObj.getTime())) {
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    return `${day}/${month}/${year}`;
                }
                
                // Si todo falla, devolver el string original
                return fechaStr;
            } catch (error) {
                console.error('Error al formatear fecha:', error);
                return fecha.toString();
            }
        }

        // Función para cargar datos de cliente
        function loadClientData(invoice) {
            const clientFields = {
                'cliente-nombre': invoice['Cliente'],
                'cliente-nif': invoice['NIF'],
                'cliente-email': invoice['Email'],
                'cliente-direccion': invoice['Dirección'],
                'cliente-cp': invoice['CP'],
                'cliente-ciudad': invoice['Ciudad'],
                'cliente-provincia': invoice['Provincia']
            };
            Object.entries(clientFields).forEach(([id, value]) => {
                document.getElementById(id).value = value || '';
            });
        }

        // Función para recibir datos desde el grid (una sola línea)
        function loadInvoiceData(invoice) {
            document.getElementById('items-container').innerHTML = '';
            itemCount = 0;
            
            loadClientData(invoice);
            
            document.getElementById('factura-serie').value = invoice['Serie'] || '';
            document.getElementById('factura-numero').value = invoice['Número'] || '';
            document.getElementById('factura-fecha').value = formatInvoiceDate(invoice['Fecha']);
            
            document.getElementById('operacion-descripcion').value = invoice['Descripción'] || '';
            // Convertir Markdown a HTML para el editor
            const textoLibreMarkdown = invoice['Texto Libre'] || '';
            document.getElementById('texto-libre').innerHTML = markdownToHtml(textoLibreMarkdown);
            
            // Cargar detalle si existe
            if (invoice['Detalle']) {
                addItem();
                document.getElementById(`desc-${itemCount}`).value = invoice['Detalle'];
                document.getElementById(`qty-${itemCount}`).value = invoice['Cantidad'] || '1';
                document.getElementById(`price-${itemCount}`).value = invoice['Precio'] || '0';
                // Formateo qty y price SIEMPRE
                document.getElementById(`qty-${itemCount}`).value = formatNumber(parseNumberES(document.getElementById(`qty-${itemCount}`).value));
                document.getElementById(`price-${itemCount}`).value = formatNumber(parseNumberES(document.getElementById(`price-${itemCount}`).value));
                // Calcular IVA desde Base Imponible e IVA
                const base = parseFloat(invoice['Base Imponible']?.toString().replace(',', '.')) || 0;
                const iva = parseFloat(invoice['IVA']?.toString().replace(',', '.')) || 0;
                const ivaPercent = base > 0 ? Math.round((iva / base) * 100) : 21;
                document.getElementById(`iva-${itemCount}`).value = ivaPercent.toString();
                calculateItemTotal(itemCount);
            }
        }
        
        // Función para cargar múltiples líneas de factura
        function loadInvoiceDataMultiLine(invoiceLines) {
            if (!invoiceLines || invoiceLines.length === 0) {
                return;
            }
            
            document.getElementById('items-container').innerHTML = '';
            itemCount = 0;
            
            const firstLine = invoiceLines[0];
            loadClientData(firstLine);
            
            document.getElementById('factura-serie').value = firstLine['Serie'] || '';
            document.getElementById('factura-numero').value = firstLine['Número'] || '';
            document.getElementById('factura-fecha').value = formatInvoiceDate(firstLine['Fecha']);
            document.getElementById('operacion-descripcion').value = firstLine['Descripción'] || '';
            // Convertir Markdown a HTML para el editor
            const textoLibreMarkdown = firstLine['Texto Libre'] || '';
            document.getElementById('texto-libre').innerHTML = markdownToHtml(textoLibreMarkdown);
            
            // Cargar cada línea como un concepto separado
            invoiceLines.forEach((line, index) => {
                addItem();
                
                // Usar el detalle de cada línea, o crear una descripción genérica
                const descripcion = line['Detalle'] || `Concepto ${index + 1}`;
                const cantidad = line['Cantidad'] || '1';
                const precio = line['Precio'] || '0';
                
                document.getElementById(`desc-${itemCount}`).value = descripcion;
                document.getElementById(`qty-${itemCount}`).value = cantidad;
                document.getElementById(`price-${itemCount}`).value = precio;
                
                // Formateo qty y price SIEMPRE
                document.getElementById(`qty-${itemCount}`).value = formatNumber(parseNumberES(document.getElementById(`qty-${itemCount}`).value));
                document.getElementById(`price-${itemCount}`).value = formatNumber(parseNumberES(document.getElementById(`price-${itemCount}`).value));
                
                // Calcular IVA desde Base Imponible e IVA de cada línea
                const base = parseFloat(line['Base Imponible']?.toString().replace(',', '.')) || 0;
                const iva = parseFloat(line['IVA']?.toString().replace(',', '.')) || 0;
                const ivaPercent = base > 0 ? Math.round((iva / base) * 100) : 21;
                document.getElementById(`iva-${itemCount}`).value = ivaPercent.toString();
                
                calculateItemTotal(itemCount);
            });
        }
        
        // Función legacy para compatibilidad
        function showLoadFromSheetsDialog() {
            openGridWindow();
        }

        // Función para parsear múltiples formatos de fecha
        function parseDateFormat(input) {
            if (!input) return null;
            
            // Limpiar espacios y convertir a mayúsculas
            input = input.trim().toUpperCase();
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentCentury = Math.floor(currentYear / 100) * 100;
            
            let day, month, year;
            
            // Formato: DDMMAA (6 dígitos)
            if (/^\d{6}$/.test(input)) {
                day = parseInt(input.substring(0, 2));
                month = parseInt(input.substring(2, 4));
                year = parseInt(input.substring(4, 6));
                year = year < 50 ? 2000 + year : 1900 + year; // Asume 2000+ si < 50
            }
            // Formato: DDMMAAAA (8 dígitos)
            else if (/^\d{8}$/.test(input)) {
                day = parseInt(input.substring(0, 2));
                month = parseInt(input.substring(2, 4));
                year = parseInt(input.substring(4, 8));
            }
            // Formato: DD-MM-AA o DD/MM/AA o DD.MM.AA (con separadores)
            else if (/^\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{2}$/.test(input)) {
                const parts = input.split(/[-\/\.]/);
                day = parseInt(parts[0]);
                month = parseInt(parts[1]);
                year = parseInt(parts[2]);
                year = year < 50 ? 2000 + year : 1900 + year;
            }
            // Formato: DD-MM-AAAA o DD/MM/AAAA o DD.MM.AAAA (con separadores y año completo)
            else if (/^\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{4}$/.test(input)) {
                const parts = input.split(/[-\/\.]/);
                day = parseInt(parts[0]);
                month = parseInt(parts[1]);
                year = parseInt(parts[2]);
            }
            // Formato ya correcto: DD/MM/AAAA
            else {
                return input; // Retornar sin cambios
            }
            
            // Validar rangos
            if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
                return null;
            }
            
            // Formatear a dd/mm/yyyy
            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }

        // Formateo automático del campo de fecha
        function setupDateTimeFormatting() {
            const fechaInput = document.getElementById('factura-fecha');
            if (!fechaInput) return;
            
            fechaInput.addEventListener('blur', function(e) {
                const value = e.target.value.trim();
                if (!value) return;
                
                const formattedDate = parseDateFormat(value);
                
                if (formattedDate) {
                    e.target.value = formattedDate;
                } else {
                    showNotification('Formato de fecha no válido. Formatos aceptados:\n• DDMMAA (ejemplo: 090125)\n• DDMMAAAA (ejemplo: 09012025)\n• DD-MM-AA (ejemplo: 09-01-25)\n• DD/MM/YYYY (ejemplo: 09/01/2025)', 'error', 8000);
                    e.target.focus();
                }
            });
        }

        // Añadir primer item por defecto
        addItem();
        
        // ========== GOOGLE SHEETS INTEGRATION ==========
        const SPREADSHEET_ID = '1qCDvaMEERQ3lm1MLWQnl2TblwtxA-17hoFo8leG70kg';
        
                    // IMPORTANTE: URL actualizada con el nuevo despliegue corregido
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx6Bv3I-L_BpQLWwSjHUJRIxh5vK7Et5IqC1psOpmUW5sCKGZUiggwKJ6MzpX50FRUj/exec';
        //const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzpbyF9R3O24Xik25abruW8jUy6DrsyRgBsJDpWRfVFxmZrdq5Gr7NYHu2FS1MWb-ly/exec';
        
        
        // Funciones para el botón de imprimir dinámico (DESHABILITADAS)
        function showPrintButton() {
            // Función deshabilitada - no se agrega botón de imprimir al desplegable de Herramientas
            return;
        }

        function hidePrintButton() {
            // Función deshabilitada - no se agrega botón de imprimir al desplegable de Herramientas  
            return;
        }

        // Funciones adicionales de Gestión de Facturas
        function loadInvoiceFromGrid() {
            // Primero abrir el grid si no está visible
            const gridSection = document.getElementById('grid-section');
            
            if (gridSection && gridSection.style.display === 'none') {
                toggleGridView();
            }
            
            showNotification('Seleccione una factura de la lista y haga clic en "Cargar Factura"', 'info');
        }
        
        // Función para exportar a Excel en formato XLSX real
        function exportToExcel() {
            if (!invoicesData || invoicesData.length === 0) {
                // Si no hay datos en el grid, intentar exportar la factura actual
                const preview = document.getElementById('invoice-preview');
                if (!preview || preview.innerHTML.includes('Vista Previa de Factura') || preview.innerHTML.includes('Complete el formulario')) {
                    showNotification('No hay datos para exportar. Genere una factura o cargue el listado de facturas.', 'warning', 10000);
                    return;
                }
                
                // Exportar factura actual
                exportCurrentInvoiceToExcel();
                return;
            }
            
            // Crear datos para el libro de Excel
            const worksheetData = [];
            
            // Añadir encabezados
            worksheetData.push(headers);
            
            // Añadir datos
            invoicesData.forEach(invoice => {
                const row = headers.map(header => invoice[header] || '');
                worksheetData.push(row);
            });
            
            // Crear libro de trabajo
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Configurar anchos de columna
            const columnWidths = headers.map(header => {
                if (header === 'Cliente' || header === 'Dirección' || header === 'Descripción') {
                    return { wch: 30 };
                } else if (header === 'Email') {
                    return { wch: 25 };
                } else if (header === 'Detalle') {
                    return { wch: 40 };
                } else {
                    return { wch: 15 };
                }
            });
            worksheet['!cols'] = columnWidths;
            
            // Añadir hoja al libro
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Facturas');
            
            // Generar y descargar archivo XLSX
            const fileName = `facturas_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showNotification('✓ Facturas exportadas a Excel XLSX', 'success');
        }
        
        function exportCurrentInvoiceToExcel() {
            // Obtener datos de la factura actual del formulario
            const invoiceData = {
                'Fecha': document.getElementById('factura-fecha').value,
                'Serie': document.getElementById('factura-serie').value,
                'Número': document.getElementById('factura-numero').value,
                'Cliente': document.getElementById('cliente-nombre').value,
                'NIF': document.getElementById('cliente-nif').value,
                'Email': document.getElementById('cliente-email').value,
                'Dirección': document.getElementById('cliente-direccion').value,
                'CP': document.getElementById('cliente-cp').value,
                'Ciudad': document.getElementById('cliente-ciudad').value,
                'Provincia': document.getElementById('cliente-provincia').value,
                'Descripción': document.getElementById('operacion-descripcion').value
            };
            
            // Calcular totales de los items
            let baseTotal = 0;
            let ivaTotal = 0;
            let total = 0;
            let itemsDetail = '';
            
            const items = document.querySelectorAll('#items-container .item-row');
            items.forEach((item, index) => {
                const id = item.id.split('-')[1];
                const desc = document.getElementById(`desc-${id}`).value;
                const qtyValue = document.getElementById(`qty-${id}`).value;
                const priceValue = document.getElementById(`price-${id}`).value;
                const qty = parseNumberES(qtyValue);
                const price = parseNumberES(priceValue);
                const ivaValue = document.getElementById(`iva-${id}`).value;
                const iva = ivaValue !== '' ? parseFloat(ivaValue) : 21;
                
                if (desc && qty && price) {
                    const itemSubtotal = qty * price;
                    const itemIVA = itemSubtotal * (iva / 100);
                    baseTotal += itemSubtotal;
                    ivaTotal += itemIVA;
                    total += itemSubtotal + itemIVA;
                    
                    if (index > 0) itemsDetail += '; ';
                    itemsDetail += `${desc} (${formatNumber(qty)}x${formatNumber(price)}€)`;
                }
            });
            
            invoiceData['Base Imponible'] = formatNumber(baseTotal);
            invoiceData['IVA'] = formatNumber(ivaTotal);
            invoiceData['Total'] = formatNumber(total);
            invoiceData['Detalle'] = itemsDetail;
            
            // Crear datos para Excel
            const worksheetData = [];
            const headers = Object.keys(invoiceData);
            const values = Object.values(invoiceData);
            
            // Añadir encabezados y datos
            worksheetData.push(headers);
            worksheetData.push(values);
            
            // Crear libro de trabajo
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Configurar anchos de columna
            const columnWidths = headers.map(header => {
                if (header === 'Cliente' || header === 'Dirección' || header === 'Descripción' || header === 'Detalle') {
                    return { wch: 40 };
                } else if (header === 'Email') {
                    return { wch: 25 };
                } else {
                    return { wch: 15 };
                }
            });
            worksheet['!cols'] = columnWidths;
            
            // Añadir hoja al libro
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Factura');
            
            // Generar y descargar archivo XLSX
            const fileName = `factura_${document.getElementById('factura-numero').value || 'nueva'}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showNotification('✓ Factura exportada a Excel XLSX', 'success');
        }
        
        // Efecto de scroll en el header
        window.addEventListener('scroll', function() {
            const header = document.getElementById('main-header');
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // Inicialización del sistema
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button[onclick]');
            
            // Inicializar el estado del dropdown
            updateDropdownState('form');
            
            // Configurar formateo automático de fecha
            setupDateTimeFormatting();
            
            // Configurar búsqueda automática con debounce
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchInvoices();
                    }, 300);
                });
            }
            
            // Cargar emisores al iniciar
            loadEmisores();
        });
        
        // Evento global para manejar Enter en filtros
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.querySelector('.filter-menu')) {
                const activeElement = document.activeElement;
                if (activeElement && ['filterValue', 'filterCondition'].includes(activeElement.id)) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.currentFilterColumn) applyFilter(window.currentFilterColumn);
                }
            }
        });

        // ==============================================
        // GESTIÓN DE EMISORES
        // ==============================================

        let emisoresData = [];
        let currentEmisorId = null;
        let editingEmisorId = null;
        let isLoadingEmisores = false;

        // Mostrar modal de gestión de emisores
        function showEmisoresManager() {
            document.getElementById('emisoresModal').style.display = 'flex';
            loadEmisores();
        }

        // Cerrar modal de gestión de emisores
        function closeEmisoresModal() {
            document.getElementById('emisoresModal').style.display = 'none';
            editingEmisorId = null;
        }

        // Cambiar entre tabs
        function showEmisoresTab(tabName) {
            // Ocultar todas las tabs
            document.querySelectorAll('.emisores-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.emisores-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab seleccionada
            document.getElementById(`emisores-${tabName}-tab`).classList.add('active');
            
            // Activar el botón de tab correspondiente
            const targetButton = document.querySelector(`.emisores-tab[onclick*="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            if (tabName === 'list') {
                loadEmisoresTable();
            }
        }

        // Crear nueva hoja de emisores en Google Sheets
        async function createEmisoresSheet() {
            try {
                const response = await fetch(WEB_APP_URL + '?action=createEmisoresSheet');
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Hoja de emisores creada correctamente', 'success');
                    // Recargar emisores después de crear la hoja
                    setTimeout(() => loadEmisores(), 1000);
                    return true;
                } else {
                    console.error('Error al crear hoja de emisores:', result.error);
                    showNotification('Error al crear hoja de emisores: ' + result.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error de conexión al crear hoja de emisores:', error);
                showNotification('Error de conexión al crear hoja de emisores: ' + error.message, 'error');
                return false;
            }
        }

        // Cargar emisores desde Google Sheets
        function loadEmisores() {
            isLoadingEmisores = true;
            
            fetch(WEB_APP_URL + '?action=getEmisores')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        emisoresData = result.data || [];
                        loadEmisoresTable();
                        isLoadingEmisores = false;
                        
                        if (emisoresData.length > 0 && !currentEmisorId) {
                            selectEmisor(emisoresData[0].id, true);
                        }
                        
                        if (emisoresData.length === 0) {
                            createEmisoresSheet();
                        }
                    } else {
                        console.error('Error al cargar emisores:', result.error);
                        if (result.error && result.error.includes('no existe')) {
                            createEmisoresSheet();
                        } else {
                            showNotification('Error al cargar emisores: ' + result.error, 'error');
                        }
                        isLoadingEmisores = false;
                    }
                })
                .catch(error => {
                    console.error('Error de conexión al cargar emisores:', error);
                    showNotification('Error de conexión al cargar emisores: ' + error.message, 'error');
                    isLoadingEmisores = false;
                });
        }

        // Mostrar tabla de emisores
        function loadEmisoresTable() {
            const container = document.getElementById('emisores-list');
            
            if (!emisoresData || emisoresData.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        <p>No hay emisores registrados</p>
                        <button class="btn btn-primary" onclick="showEmisoresTab('form'); resetEmisorForm()">➕ Añadir Primer Emisor</button>
                    </div>
                `;
                return;
            }

            let html = '';
            emisoresData.forEach((emisor, index) => {
                const isActive = emisor.id === currentEmisorId;
                html += `
                    <div class="emisor-item ${isActive ? 'active' : ''}">
                        <div class="emisor-info">
                            <div class="emisor-name">
                                ${emisor.nombre || 'Sin nombre'}
                                ${isActive ? '<span style="color: #27ae60; font-size: 12px;">✓ ACTIVO</span>' : ''}
                            </div>
                            <div class="emisor-details">
                                ${emisor.nif || 'Sin NIF'} • ${emisor.telefono || 'Sin teléfono'}
                            </div>
                        </div>
                        <div class="emisor-actions">
                            <button class="btn-small btn-edit" onclick="editEmisor('${emisor.id}')">Editar</button>
                            <button class="btn-small btn-select" onclick="selectEmisor('${emisor.id}')">
                                ${isActive ? 'Activo' : 'Activar'}
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteEmisor('${emisor.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Formatear y rellenar código postal
        function formatCodigoPostal(input) {
            input.value = input.value.replace(/\D/g, '').substring(0, 5);
        }

        function padCodigoPostal(input) {
            const value = input.value.replace(/\D/g, '');
            if (value.length > 0 && value.length < 5) input.value = value.padStart(5, '0');
        }

        // Resetear formulario de emisor
        function resetEmisorForm() {
            document.getElementById('emisor-form').reset();
            document.getElementById('emisor-id').value = '';
            document.getElementById('form-title').textContent = 'Nuevo Emisor';
            editingEmisorId = null;
        }

        // Editar emisor
        function editEmisor(id) {
            const emisor = emisoresData.find(e => e.id == id); // Usar == en lugar de ===
            if (!emisor) return;

            editingEmisorId = id;
            document.getElementById('emisor-id').value = id;
            document.getElementById('form-emisor-nombre').value = emisor.nombre || '';
            document.getElementById('form-emisor-nif').value = emisor.nif || '';
            document.getElementById('form-emisor-telefono').value = emisor.telefono || '';
            document.getElementById('form-emisor-email').value = emisor.email || '';
            document.getElementById('form-emisor-direccion').value = emisor.direccion || '';
            document.getElementById('form-emisor-ciudad').value = emisor.ciudad || '';
            document.getElementById('form-emisor-cp').value = emisor.cp || '';
            document.getElementById('form-emisor-provincia').value = emisor.provincia || '';
            
            document.getElementById('form-title').textContent = 'Editar Emisor';
            showEmisoresTab('form');
        }

        // Seleccionar emisor activo
        function selectEmisor(id, silent = false) {
            if (isLoadingEmisores && !silent) {
                showNotification('⏳ Esperando a que terminen de cargar los emisores...', 'warning');
                return;
            }
            
            currentEmisorId = id;
            const emisor = emisoresData ? emisoresData.find(e => e.id == id) : null;
            
            if (emisor) {
                // Actualizar campos del emisor en el formulario principal
                const emisorFields = {
                    'emisor-nombre': emisor.nombre,
                    'emisor-nif': emisor.nif,
                    'emisor-telefono': emisor.telefono,
                    'emisor-direccion': emisor.direccion,
                    'emisor-cp': emisor.cp,
                    'emisor-ciudad': emisor.ciudad
                };
                
                Object.entries(emisorFields).forEach(([id, value]) => {
                    document.getElementById(id).value = value || '';
                });
                
                // Actualizar provincia en el select
                const provinciaSelect = document.getElementById('emisor-provincia');
                if (emisor.provincia) {
                    const optionExists = Array.from(provinciaSelect.options).some(opt => opt.value === emisor.provincia);
                    
                    if (!optionExists) {
                        const newOption = document.createElement('option');
                        newOption.value = emisor.provincia;
                        newOption.textContent = emisor.provincia;
                        provinciaSelect.appendChild(newOption);
                    }
                    provinciaSelect.value = emisor.provincia;
                }
                
                loadEmisoresTable();
                
                if (!silent) {
                    showNotification(`Emisor "${emisor.nombre}" seleccionado como activo`, 'success');
                    closeEmisoresModal();
                }
            } else {
                console.error('ERROR: Emisor no encontrado para ID:', id);
                if (!silent) showNotification('Error: Emisor no encontrado', 'error');
            }
        }

        // Eliminar emisor
        function deleteEmisor(id) {
            if (isLoadingEmisores) {
                showNotification('⏳ Esperando a que terminen de cargar los emisores...', 'warning');
                return;
            }
            
            const emisor = emisoresData ? emisoresData.find(e => e.id == id) : null;
            
            if (!emisor) {
                showNotification('Error: Emisor no encontrado', 'error');
                return;
            }

            if (confirm(`¿Está seguro de que desea eliminar al emisor "${emisor.nombre}"?`)) {
                fetch(`${WEB_APP_URL}?action=deleteEmisor&id=${encodeURIComponent(id)}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showNotification('Emisor eliminado correctamente', 'success');
                            loadEmisores(); // Recargar lista
                            
                            // Si era el emisor activo, limpiar selección
                            if (currentEmisorId === id) {
                                currentEmisorId = null;
                                document.getElementById('emisor-nombre').value = '';
                                document.getElementById('emisor-nif').value = '';
                                document.getElementById('emisor-telefono').value = '';
                            }
                        } else {
                            showNotification('Error al eliminar emisor: ' + result.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error al eliminar emisor:', error);
                        showNotification('Error al eliminar emisor', 'error');
                    });
            }
        }

        // Manejar formulario de emisor (se configura cuando el DOM esté listo)
        function setupEmisorFormHandler() {
            const form = document.getElementById('emisor-form');
            if (!form) {
                console.warn('Formulario emisor-form no encontrado, reintentando...');
                setTimeout(setupEmisorFormHandler, 100);
                return;
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const existingId = document.getElementById('emisor-id').value.trim();
                const isEditing = !!existingId;
                
                const formData = {
                    id: isEditing ? existingId : Date.now().toString(),
                    nombre: document.getElementById('form-emisor-nombre').value.trim(),
                    nif: document.getElementById('form-emisor-nif').value.trim(),
                    telefono: document.getElementById('form-emisor-telefono').value.trim(),
                    email: document.getElementById('form-emisor-email').value.trim(),
                    direccion: document.getElementById('form-emisor-direccion').value.trim(),
                    ciudad: document.getElementById('form-emisor-ciudad').value.trim(),
                    cp: document.getElementById('form-emisor-cp').value.trim(),
                    provincia: document.getElementById('form-emisor-provincia').value.trim()
                };

                if (!formData.nombre || !formData.nif) {
                    showNotification('Nombre y NIF son obligatorios', 'error');
                    return;
                }

                fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'saveEmisor', data: formData })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification(isEditing ? 'Emisor actualizado correctamente' : 'Emisor creado correctamente', 'success');
                        loadEmisores();
                        showEmisoresTab('list');
                        resetEmisorForm();
                    } else {
                        console.error('Error del servidor:', result.error);
                        showNotification('Error al guardar emisor: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error al guardar emisor:', error);
                    showNotification('Error al guardar emisor', 'error');
                });
            });
        }

        // Función para limpiar emisores de prueba (ejecutar desde consola)
        function limpiarEmisoresPrueba() {
            if (!confirm('¿Está seguro de que desea eliminar TODOS los emisores de prueba? Esta acción no se puede deshacer.')) return;
            
            fetch(WEB_APP_URL + '?action=getEmisores')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const emisoresPrueba = result.data.filter(emisor => 
                            emisor.nombre && (
                                emisor.nombre.toLowerCase().includes('prueba') ||
                                emisor.nombre.toLowerCase().includes('test') ||
                                emisor.nombre.toLowerCase().includes('ejemplo') ||
                                emisor.nif === '12345678A' ||
                                emisor.nif === 'A12345678'
                            )
                        );
                        
                        if (emisoresPrueba.length === 0) {
                            showNotification('No se encontraron emisores de prueba para eliminar', 'info');
                            return;
                        }
                        
                        let eliminados = 0;
                        emisoresPrueba.forEach((emisor, index) => {
                            setTimeout(() => {
                                fetch(`${WEB_APP_URL}?action=deleteEmisor&id=${encodeURIComponent(emisor.id)}`)
                                    .then(response => response.json())
                                    .then(deleteResult => {
                                        if (deleteResult.success) {
                                            eliminados++;
                                            if (eliminados === emisoresPrueba.length) {
                                                showNotification(`${eliminados} emisores de prueba eliminados correctamente`, 'success');
                                                currentEmisorId = null;
                                                loadEmisores();
                                            }
                                        } else {
                                            console.error(`Error al eliminar emisor ${emisor.nombre}:`, deleteResult.error);
                                        }
                                    })
                                    .catch(error => console.error(`Error al eliminar emisor ${emisor.nombre}:`, error));
                            }, index * 500);
                        });
                    } else {
                        console.error('Error al obtener emisores:', result.error);
                        showNotification('Error al obtener emisores: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error de conexión:', error);
                    showNotification('Error de conexión: ' + error.message, 'error');
                });
        }

        // Funciones para llamar desde el dropdown
        function addNewEmisor() {
            showEmisoresManager();
            showEmisoresTab('form');
            resetEmisorForm();
        }

        // Cerrar modal al hacer clic fuera
        function setupModalHandler() {
            const modal = document.getElementById('emisoresModal');
            if (!modal) {
                console.warn('Modal emisoresModal no encontrado, reintentando...');
                setTimeout(setupModalHandler, 100);
                return;
            }
            modal.addEventListener('click', function(e) {
                if (e.target === this) closeEmisoresModal();
            });
        }

        // Inicializar handlers
        const initHandlers = () => {
            setupEmisorFormHandler();
            setupModalHandler();
        };

        // Detectar si se abrió con parámetro view=grid
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('view') === 'grid') {
                // Abrir automáticamente el grid
                setTimeout(() => {
                    toggleGridView();
                }, 100);
            }
        }

        // Variable para controlar el parpadeo del título
        let titleBlinkInterval = null;
        const originalTitle = document.title;
        
        // Listener para recibir mensajes de ventanas hijas (listado de facturas)
        window.addEventListener('message', (event) => {
            // Verificar que el mensaje es del tipo correcto
            if (event.data && event.data.type === 'LOAD_INVOICE') {
                const allInvoiceLines = event.data.data;
                if (allInvoiceLines && allInvoiceLines.length > 0) {
                    // Hacer parpadear el título de la pestaña
                    let blinkCount = 0;
                    if (titleBlinkInterval) clearInterval(titleBlinkInterval);
                    
                    titleBlinkInterval = setInterval(() => {
                        document.title = blinkCount % 2 === 0 ? '🔔 ¡FACTURA LISTA!' : originalTitle;
                        blinkCount++;
                        if (blinkCount > 20) { // Parpadear 10 veces
                            clearInterval(titleBlinkInterval);
                            document.title = originalTitle;
                        }
                    }, 500);
                    
                    // Cargar datos en el formulario
                    loadInvoiceDataMultiLine(allInvoiceLines);
                    
                    // Si el grid está visible, ocultarlo
                    const gridSection = document.getElementById('grid-section');
                    const mainContainer = document.querySelector('.container');
                    if (gridSection && gridSection.style.display !== 'none') {
                        toggleGridView();
                    }
                    
                    // Generar automáticamente la vista previa sin preguntar si desea guardar
                    setTimeout(() => {
                        generateInvoice(true);
                    }, 300); // Pequeño delay para asegurar que los datos estén cargados
                }
            }
        });
        
        // Detener parpadeo cuando la ventana recibe el foco
        window.addEventListener('focus', () => {
            if (titleBlinkInterval) {
                clearInterval(titleBlinkInterval);
                document.title = originalTitle;
            }
        });

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            initHandlers();
            checkUrlParameters();
        });
        if (document.readyState !== 'loading') {
            initHandlers();
            checkUrlParameters();
        }
        
    </script>

    <!-- Modal de Gestión de Emisores -->
    <div id="emisoresModal" class="emisores-modal">
        <div class="emisores-modal-content">
            <div class="emisores-modal-header">
                <h3>🏢 Gestión de Emisores</h3>
                <span class="emisores-modal-close" onclick="closeEmisoresModal()">×</span>
            </div>
            <div class="emisores-modal-body">
                <div class="emisores-tabs">
                    <button class="emisores-tab active" onclick="showEmisoresTab('list')">📋 Lista de Emisores</button>
                    <button class="emisores-tab" onclick="showEmisoresTab('form')">✏️ Añadir/Editar</button>
                </div>

                <!-- Tab: Lista de Emisores -->
                <div id="emisores-list-tab" class="emisores-tab-content active">
                    <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;">Emisores Registrados</h4>
                        <button class="btn btn-primary" onclick="showEmisoresTab('form'); resetEmisorForm()">➕ Nuevo Emisor</button>
                    </div>
                    <div id="emisores-list" class="emisores-list">
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <p>Cargando emisores...</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Formulario Emisor -->
                <div id="emisores-form-tab" class="emisores-tab-content">
                    <h4 id="form-title">Nuevo Emisor</h4>
                    <form id="emisor-form">
                        <input type="hidden" id="emisor-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-emisor-nombre">Nombre/Razón Social *</label>
                                <input type="text" id="form-emisor-nombre" required>
                            </div>
                            <div class="form-group">
                                <label for="form-emisor-nif">NIF/CIF *</label>
                                <input type="text" id="form-emisor-nif" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-emisor-telefono">Teléfono</label>
                                <input type="text" id="form-emisor-telefono">
                            </div>
                            <div class="form-group">
                                <label for="form-emisor-email">Email</label>
                                <input type="email" id="form-emisor-email">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="form-emisor-direccion">Dirección</label>
                            <input type="text" id="form-emisor-direccion">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="form-emisor-ciudad">Ciudad</label>
                                <input type="text" id="form-emisor-ciudad">
                            </div>
                            <div class="form-group">
                                <label for="form-emisor-cp">Código Postal</label>
                                <input type="text" id="form-emisor-cp" placeholder="01009">
                            </div>
                            <div class="form-group">
                                <label for="form-emisor-provincia">Provincia</label>
                                <input type="text" id="form-emisor-provincia">
                            </div>
                        </div>

                        <div class="filter-menu-actions" style="margin-top: 20px;">
                            <button type="button" class="filter-btn filter-btn-cancel" onclick="showEmisoresTab('list')">Cancelar</button>
                            <button type="submit" class="filter-btn filter-btn-apply">Guardar Emisor</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

<!--
═══════════════════════════════════════════════════════════════════════════════

═══════════════════════════════════════════════════════════════════════════════

Añade esta línea en Google Apps Script (hay 2 lugares):

LUGAR 1 - Dentro de itemsDetail.forEach (línea ~43-62):
Después de: data.descripcion || '',
Añade:    data.textoLibre || '',      // Texto Libre

LUGAR 2 - Modo clásico (línea ~66-86):
Después de: data.descripcion || '',
Añade:    data.textoLibre || '',      // Texto Libre

Esto es todo. La columna "Texto Libre" ya la creaste en Sheets.
═══════════════════════════════════════════════════════════════════════════════
-->

